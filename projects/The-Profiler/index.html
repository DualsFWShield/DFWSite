<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>
        The Profiler
    </title>
    <meta name="robots" content="noindex,nofollow">
    <!-- CDN pour jsPDF et jsPDF-AutoTable pour l'export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- CDN pour Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #0d1117;
            --surface: #161b22;
            --card: #21262d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --border: #30363d;
            --accent: #58a6ff;
            --good: #3fb950;
            --warn: #d29922;
            --bad: #f85149;
            --glass: rgba(56, 139, 253, 0.07);
            --maxw: 1200px;
            --gutter: 4vw;
            --radius: 0.75rem;
            --card-pad: 1.25rem;
            --gap: 0.8rem;
            --shadow: 0 8px 24px rgba(0,0,0,0.2);
            --btn-h: 2.8rem;
        }

        body.light-theme {
            --bg: #f6f8fa;
            --surface: #ffffff;
            --card: #ffffff;
            --text-primary: #24292f;
            --text-secondary: #57606a;
            --border: #d0d7de;
            --accent: #0969da;
            --good: #1a7f37;
            --warn: #9a6700;
            --bad: #cf222e;
            --glass: rgba(9, 105, 218, 0.07);
            --shadow: 0 6px 18px rgba(140,149,159,0.15);
        }

        html { font-size: clamp(14px, 1.8vw, 16px); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; box-sizing: border-box; }
        *, *::before, *::after { box-sizing: inherit; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; background-color: var(--bg); color: var(--text-primary); min-height: 100vh; line-height: 1.45; transition: background-color 0.2s, color 0.2s; }
        .wrap { width: min(96%, var(--maxw)); margin: 0 auto; padding: calc(var(--gutter) / 2); }
        header { margin-bottom: calc(var(--gap) * 1.5); padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        h1 { font-size: clamp(1.25rem, 3.2vw, 1.5rem); margin: 0 0 0.35rem; font-weight: 600; }
        p.lead { margin: 0; color: var(--text-secondary); font-size: clamp(0.9rem, 1.8vw, 1rem); }
        form.card, .panel.card { background-color: var(--card); border: 1px solid var(--border); padding: var(--card-pad); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: calc(var(--gap) * 1.25); }
        input#userName { background-color: var(--surface); border: 1px solid var(--border); border-radius: calc(var(--radius) / 1.5); padding: 0.5rem 0.75rem; color: var(--text-primary); width: 100%; margin-bottom: 1rem; font-size: 1rem; }
        .section-title { font-weight: 600; margin: 0.35rem 0 0.8rem; font-size: clamp(1rem, 2.6vw, 1.15rem); color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        .q { background: var(--glass); padding: calc(var(--gap) * 1.1); border-radius: calc(var(--radius) / 1.2); margin: 0.8rem 0; border: 1px solid transparent; }
        label.opt { display: flex; align-items: center; gap: 0.7rem; padding: 0.5rem 0.25rem; cursor: pointer; font-size: clamp(0.9rem, 1.9vw, 1rem); }
        .options { display: flex; flex-direction: column; gap: 0.45rem; }
        input[type="radio"], input[type="checkbox"] { transform: scale(1.1); flex-shrink: 0; accent-color: var(--accent); }
        input[type="range"] { width: 100%; max-width: 100%; margin: 0.35rem 0; accent-color: var(--accent); }
        button.btn { appearance: none; border: 1px solid var(--accent); padding: 0.5rem 1rem; border-radius: calc(var(--radius) / 1.2); background-color: var(--accent); color: white; font-weight: 600; cursor: pointer; margin-top: 0.5rem; display: block; width: 100%; height: var(--btn-h); font-size: clamp(0.95rem, 1.8vw, 1.05rem); transition: all 0.2s ease; }
        button.btn:hover { filter: brightness(1.1); }
        button.ghost { background: transparent; border: 1px solid var(--border); color: var(--accent); }
        button.ghost:hover { background: var(--glass); border-color: var(--accent); }
        .grid { display: grid; grid-template-columns: 1fr; gap: calc(var(--gap) * 1.25); align-items: start; }
        .aside { display: block; }
        .results { font-size: clamp(0.9rem, 1.6vw, 1rem); background-color: var(--surface); padding: 0.6rem; border-radius: calc(var(--radius) / 1.2); }
        .report-section { background-color: var(--card); border: 1px solid var(--border); padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem; }
        .report-title { font-weight: 600; font-size: 1.1rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .report-bar { height: 8px; background-color: var(--surface); border-radius: 4px; overflow: hidden; margin: 0.5rem 0 1rem; }
        .report-bar i { display: block; height: 100%; border-radius: 4px; }
        .report-description { font-size: 0.9rem; color: var(--text-secondary); white-space: pre-wrap; }
        .muted { color: var(--text-secondary); }
        footer { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); font-size: clamp(0.8rem, 1.4vw, 0.9rem); color: var(--text-secondary); text-align: center; }
        pre.jsonOut { background: var(--surface); border: 1px solid var(--border); padding: 0.8rem; border-radius: calc(var(--radius) / 1.2); overflow: auto; font-size: clamp(0.8rem, 1.4vw, 0.9rem); white-space: pre-wrap; word-break: break-word; color: var(--text-secondary); }
        .header-controls { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
        .lang-switch, .theme-switch { display: flex; align-items: center; gap: 0.5rem; }
        .lang-switch select, .theme-switch button { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 0.35rem 0.6rem; border-radius: 6px; cursor: pointer; font-size: 1.2rem; line-height: 1; }
        .lang-switch label { font-size: 0.9rem; }
        #chartContainer { position: relative; min-height: 250px; margin-top: 1rem; }
        
        @media (min-width: 760px) {
            .grid { grid-template-columns: 1fr minmax(320px, 36%); gap: calc(var(--gap) * 1.4); }
        }
        @media (min-width: 980px) {
            .wrap { padding: calc(var(--gutter) / 1.2); }
            .grid { grid-template-columns: 1fr 34%; gap: calc(var(--gap) * 1.6); }
            .aside { position: sticky; top: 1.25rem; align-self: start; }
            .form-buttons { display: flex; gap: 0.75rem; }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header>
            <div class="header-controls">
                <div>
                    <h1>The Profiler</h1>
                    <p class="lead">
                        Application locale ‚Äî donn√©es conserv√©es
                        uniquement c√¥t√© client.
                    </p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div class="lang-switch">
                        <label class="muted" for="langSelect">Lang:</label>
                        <select id="langSelect" aria-label="Choisir la langue">
                            <option value="index.html">Fr</option>
                            <option value="en-us.html">En</option>
                        </select>
                    </div>
                     <div class="theme-switch">
                        <button id="themeToggle" title="Changer le th√®me">üåó</button>
                    </div>
                </div>
            </div>
        </header>
        <div class="grid">
            <form id="profilerForm" class="card" onsubmit="event.preventDefault(); runAll();">
                
                <input type="text" id="userName" placeholder="Votre nom (pour le rapport PDF)">

                <!-- Section de s√©lection des modules -->
                <div>
                    <div class="section-title">S√©lection des Modules</div>
                    <div id="moduleSelector" class="q">
                        <!-- Checkboxes g√©n√©r√©es par JS -->
                    </div>
                </div>

                <!-- Conteneurs pour tous les questionnaires -->
                <div id="allSectionsContainer">
                    <!-- Les sections seront inject√©es ici par JS -->
                </div>
                
                <div style="margin-top:12px;" class="form-buttons">
                    <button type="submit" class="btn">
                        Analyser et G√©n√©rer le Profil
                    </button>
                    <button type="button" class="btn ghost" onclick="generatePDF()">Exporter en PDF</button>
                </div>
                 <div style="margin-top:8px;" class="form-buttons">
                    <button type="button" class="btn ghost" onclick="fillExample()">Remplir un Exemple</button>
                    <button type="button" class="ghost btn" onclick="clearForm()">R√©initialiser</button>
                </div>
                <div style="display:flex;gap:8px;margin-top:8px">
                    <button type="button" class="ghost btn" onclick="exportJson()" style="flex:1">
                        Exporter JSON
                    </button>
                    <label class="btn ghost" style="flex:1;text-align:center;line-height:1.8">
                        Importer JSON
                        <input id="importFile" type="file" accept=".json" style="display:none">
                    </label>
                </div>
            </form>
            <aside class="aside">
                <div class="panel card">
                    <div class="section-title">Rapport D√©taill√©</div>
                    <div id="report" class="results" style="max-height: 85vh; overflow-y: auto;">
                        Veuillez s√©lectionner les modules, remplir les questionnaires et cliquer sur "Analyser".
                    </div>
                </div>
                <div class="panel card" style="margin-top:12px">
                    <div class="section-title">Donn√©es JSON (pour export)</div>
                    <pre id="jsonOut" class="jsonOut" style="max-height: 200px; overflow: auto;">‚Äî</pre>
                </div>
            </aside>
        </div>
        <footer>
            <p class="muted">
                <strong>Avertissement :</strong> Ceci est un outil √©ducatif d'exploration des indices comportementaux. 
                Il ne remplace en aucun cas une √©valuation clinique par un professionnel qualifi√©.
                Si vous ou une personne que vous connaissez √™tes en d√©tresse, consultez un m√©decin ou un psychologue.
            </p>
            <p class="muted" style="margin-top: 8px;">
                Cr√©√© par DFWS
            </p>
        </footer>
    </div>
    <script>
        /* ================================================= */
        /* == DATA DEFINITIONS (QUESTIONS & DESCRIPTIONS) == */
        /* ================================================= */

        const FREQUENCY_SCALE_TEXT = '√âvaluez la fr√©quence : 0=Jamais, 1=Rarement, 2=Parfois, 3=Souvent, 4=Tr√®s souvent';
        const AGREEMENT_SCALE_TEXT = '√âvaluez votre accord : 1=Pas du tout d\'accord, 2=Plut√¥t pas d\'accord, 3=Neutre, 4=Plut√¥t d\'accord, 5=Tout √† fait d\'accord';

        const MODULES = {
            personality: {
                title: "Profil de Personnalit√©",
                enabled: true,
                sections: ['mbti', 'enneagram', 'attachment']
            },
            dark_tetrad: {
                title: "T√©trade Sombre (Dark Tetrad)",
                enabled: false,
                sections: ['antagonistic_traits']
            },
            autism: {
                title: "Spectre de l'Autisme (TSA)",
                enabled: false,
                sections: ['autism']
            },
            otroverti: {
                title: "Profil Otroverti (Ambiverti)",
                enabled: false,
                sections: ['otroverti']
            },
            adult_disorders: {
                title: "Troubles du Comportement (Adulte/Ado)",
                enabled: false,
                sections: ['top', 'conduct', 'addiction', 'intermittent', 'antisocial', 'borderline', 'narcissistic', 'ocpd']
            },
            child_disorders: {
                title: "Troubles du Comportement (Enfant)",
                enabled: false,
                sections: ['child_top', 'child_conduct', 'child_anxiety', 'child_eating']
            },
            specific_disorders: {
                title: "Troubles Sp√©cifiques",
                enabled: false,
                sections: ['social_phobia', 'ocd', 'eating_disorder', 'adhd']
            },
            big_five: {
                title: "Autres: Big Five (OCEAN)",
                enabled: false,
                sections: ['big_five']
            },
            locus_of_control: {
                title: "Autres: Locus de Contr√¥le",
                enabled: false,
                sections: ['locus_of_control']
            },
            grit: {
                title: "Autres: √âchelle de 'Grit' (Pers√©v√©rance)",
                enabled: false,
                sections: ['grit']
            },
            thinking_styles: {
                title: "Autres: Styles de Pens√©e (Distorsions Cognitives)",
                enabled: false,
                sections: ['thinking_styles']
            },
            alexithymia: {
                title: "Autres: Alexithymie",
                enabled: false,
                sections: ['alexithymia']
            }
        };

        const SECTIONS_DATA = {
            // == MODULE DE BASE ==
            mbti: {
                title: 'MBTI ‚Äî 12 questions (‚âà2‚Äì3 min)',
                items: [
                    { id: 'mb1', q: 'Apr√®s un √©v√©nement social, je me sens : (A) √ânergis√©(e) et pr√™t(e) √† poursuivre / (B) Fatigu√©(e) et j\'ai besoin de calme', A: 'E', B: 'I' },
                    { id: 'mb2', q: 'En groupe, je suis plut√¥t : (A) Celui/celle qui prend l\'initiative / (B) Celui/celle qui √©coute et observe', A: 'E', B: 'I' },
                    { id: 'mb3', q: 'Pour r√©fl√©chir, je pr√©f√®re : (A) Exprimer mes id√©es √† voix haute / (B) R√©fl√©chir en moi-m√™me', A: 'E', B: 'I' },
                    { id: 'mb4', q: 'Je fais plus confiance √† : (A) Ce qui est concret, observable / (B) Mon intuition et les concepts', A: 'S', B: 'N' },
                    { id: 'mb5', q: 'J\'apprends mieux avec : (A) Des m√©thodes pratiques, des √©tapes claires / (B) La vision d\'ensemble et les principes abstraits', A: 'S', B: 'N' },
                    { id: 'mb6', q: 'Mon attention se porte sur : (A) Les d√©tails du pr√©sent / (B) Les possibilit√©s futures', A: 'S', B: 'N' },
                    { id: 'mb7', q: 'Pour d√©cider, je privil√©gie : (A) L\'analyse logique, les crit√®res objectifs / (B) L\'impact humain et les valeurs', A: 'T', B: 'F' },
                    { id: 'mb8', q: 'On me per√ßoit comme : (A) Rationnel(le), direct(e) / (B) Empathique, diplomate', A: 'T', B: 'F' },
                    { id: 'mb9', q: 'La critique la plus difficile est : (A) "Vous √™tes illogique" / (B) "Vous avez bless√© des gens"', A: 'T', B: 'F' },
                    { id: 'mb10', q: 'Je pr√©f√®re un style de vie : (A) Organis√©, planifi√© / (B) Flexible, spontan√©', A: 'J', B: 'P' },
                    { id: 'mb11', q: 'Face √† une t√¢che, j\'ai tendance √† : (A) La planifier et la terminer t√¥t / (B) Mieux fonctionner sous pression', A: 'J', B: 'P' },
                    { id: 'mb12', q: 'J\'aime : (A) Que les choses soient d√©cid√©es / (B) Garder des options ouvertes', A: 'J', B: 'P' }
                ]
            },
            enneagram: {
                title: 'Enn√©agramme ‚Äî motivation & instinct',
                items: {
                    main: [
                        { id: 'en1', type: 1, text: 'Je veux √™tre juste, moral, et parfait.' }, { id: 'en2', type: 2, text: 'Je veux √™tre aim√© et n√©cessaire.' }, { id: 'en3', type: 3, text: 'Je veux r√©ussir et √™tre valoris√©.' }, { id: 'en4', type: 4, text: 'Je veux √™tre unique et authentique.' }, { id: 'en5', type: 5, text: 'Je veux comprendre et conserver mes ressources.' }, { id: 'en6', type: 6, text: 'Je veux s√©curit√© et soutien fiable.' }, { id: 'en7', type: 7, text: 'Je veux √©viter la douleur et maximiser le plaisir.' }, { id: 'en8', type: 8, text: 'Je veux garder le contr√¥le et ne pas √™tre domin√©.' }, { id: 'en9', type: 9, text: 'Je veux paix et harmonie.' }
                    ],
                    stress: [
                        { id: 'es1', type: 1, text: 'Tend √† critiquer quand stress√©.' }, { id: 'es2', type: 2, text: 'Tend √† sur-prot√©ger/sauver quand stress√©.' }, { id: 'es3', type: 3, text: 'Surinvestit image/travail sous stress.' }, { id: 'es4', type: 4, text: 'Devient m√©lancolique/sensible sous stress.' }, { id: 'es5', type: 5, text: 'S\'isole et accumule info sous stress.' }, { id: 'es6', type: 6, text: 'Devient anxieux/m√©fiant sous stress.' }, { id: 'es7', type: 7, text: 'Cherche distractions excessives sous stress.' }, { id: 'es8', type: 8, text: 'Devient dominateur/agressif sous stress.' }, { id: 'es9', type: 9, text: 'S\'engourdit et √©vite sous stress.' }
                    ],
                    instincts: [
                        { id: 'sp', text: 'Auto-pr√©servation (s√©curit√©, sant√©, confort)' }, { id: 'so', text: 'Social (statut, groupe, coop√©ration)' }, { id: 'sx', text: 'Sexuel (intensit√©, t√™te-√†-t√™te, passion)' }
                    ]
                }
            },
            antagonistic_traits: {
                title: 'Traits Comportementaux Antagonistes ‚Äî √©chelle 1..5',
                scaleText: AGREEMENT_SCALE_TEXT,
                items: [
                    { id: 'at1', group: 'mach', text: 'Je manipule parfois les autres pour obtenir ce que je veux.' },
                    { id: 'at2', group: 'mach', text: 'J\'utilise la flatterie pour obtenir des avantages.' },
                    { id: 'at3', group: 'mach', text: 'Je profite des autres si cela me sert.' },
                    { id: 'at4', group: 'narc', text: 'J\'aime √™tre admir√© et √™tre au centre de l\'attention.' },
                    { id: 'at5', group: 'narc', text: 'Je pense m√©riter un traitement sp√©cial et sup√©rieur.' },
                    { id: 'at6', group: 'narc', text: 'Je suis pr√©occup√©(e) par des fantaisies de succ√®s illimit√©.' },
                    { id: 'at7', group: 'psy', text: 'Je ressens peu de remords ou de culpabilit√© pour mes actes.' },
                    { id: 'at8', group: 'psy', text: 'Je suis souvent indiff√©rent(e) aux √©motions des autres.' },
                    { id: 'at9', group: 'psy', text: 'Je cherche des sensations fortes et prends des risques sans penser aux cons√©quences.' },
                    { id: 'at10', group: 'soc', text: 'J\'ai des acc√®s de col√®re soudains et intenses.' },
                    { id: 'at11', group: 'soc', text: 'J\'ai du mal √† maintenir un emploi ou des relations stables √† long terme.' },
                    { id: 'at12', group: 'soc', text: 'Je me sens souvent agit√©(e) et j\'agis de mani√®re impulsive.' }
                ]
            },
            attachment: {
                title: "Style d'attachement",
                items: [
                    { id: 'att_secure', val: 'secure', text: 'Attachement S√©cure : Je suis √† l\'aise avec l\'intimit√© et l\'ind√©pendance, et je fais confiance aux autres.' },
                    { id: 'att_anxious', val: 'anxious_fused', text: 'Attachement Anxieux/Fusionnel : Je d√©sire une grande proximit√© mais je crains l\'abandon et l\'inconstance de l\'autre.' },
                    { id: 'att_avoidant', val: 'avoidant_fearful', text: 'Attachement √âvitant/Craintif : Je pr√©f√®re l\'ind√©pendance, je me m√©fie de l\'intimit√© et garde mes distances √©motionnelles.' },
                    { id: 'att_disorganized', val: 'disorganized', text: 'Attachement D√©sorganis√©/Chaotique : Je veux √™tre proche mais j\'ai peur d\'√™tre bless√©(e) ; mes relations sont souvent intenses et instables.' }
                ]
            },
            otroverti: {
                title: 'Profil "Otroverti" (Ambiverti)',
                scaleText: FREQUENCY_SCALE_TEXT,
                items: [
                    { id: 'ot1', text: 'Mon besoin de socialisation varie beaucoup ; parfois je le recherche, parfois je l\'√©vite.' },
                    { id: 'ot2', text: 'Je suis aussi √† l\'aise en dirigeant un groupe qu\'en travaillant seul(e).' },
                    { id: 'ot3', text: 'Mon niveau d\'√©nergie d√©pend fortement de mon humeur et de l\'environnement, pas seulement de la pr√©sence des autres.' },
                    { id: 'ot4', text: 'Je prends le temps de r√©fl√©chir avant de parler, mais n\'h√©site pas √† m\'exprimer quand c\'est n√©cessaire.' },
                    { id: 'ot5', text: 'On me d√©crit parfois comme extraverti(e) et d\'autres fois comme introverti(e).' }
                ]
            },
            adhd: {
                title: 'TDA/H (screening ASRS-style ‚Äî indicatif)',
                scaleText: FREQUENCY_SCALE_TEXT,
                items: [
                    { id: 'ad1', text: 'J\'ai souvent du mal √† me concentrer sur ce qui est demand√©.' }, { id: 'ad2', text: 'J\'ai du mal √† me souvenir de choses n√©cessaires au quotidien.' }, { id: 'ad3', text: 'Je procrastine ou √©vite les t√¢ches demandant un effort mental soutenu.' }, { id: 'ad4', text: 'Je suis souvent agit√©, je bouge plus que les autres.' }, { id: 'ad5', text: 'J\'interromps souvent les autres ou parle excessivement.' }, { id: 'ad6', text: 'J\'ai du mal √† attendre mon tour ou √† rester calme dans des files d\'attente.' }
                ]
            },
            autism: {
                title: 'Trouble du Spectre de l\'Autisme (TSA)',
                description: "Indices comportementaux pouvant √™tre associ√©s au TSA. √âvaluez la fr√©quence et l'intensit√© des traits.",
                prevalence: "Environ 1 √† 2% de la population.",
                scaleText: FREQUENCY_SCALE_TEXT,
                items: [
                    { id: 'aut1', text: "J'ai des difficult√©s √† initier ou √† soutenir une conversation (r√©ciprocit√© sociale)." },
                    { id: 'aut2', text: "J'ai des comportements non verbaux atypiques (contact visuel fuyant, expressions faciales limit√©es)." },
                    { id: 'aut3', text: "J'ai des difficult√©s √† comprendre les relations, les signaux sociaux ou le langage non litt√©ral (ironie)." },
                    { id: 'aut4', text: "J'ai des mouvements, une utilisation d'objets ou un langage st√©r√©otyp√©s ou r√©p√©titifs (st√©r√©otypies, √©cholalie)." },
                    { id: 'aut5', text: "J'ai une adh√©sion inflexible √† des routines ou rituels ; je ressens de la d√©tresse face aux petits changements." },
                    { id: 'aut6', text: "J'ai des int√©r√™ts tr√®s restreints et fixes, anormaux dans leur intensit√© ou leur but." },
                    { id: 'aut7', text: "J'ai une hyper- ou hypor√©activit√© aux stimuli sensoriels (indiff√©rence √† la douleur, fascination pour des lumi√®res, aversion pour certains sons ou textures)." },
                    { id: 'aut8', text: "J'ai besoin d'un soutien notable pour mes difficult√©s sociales afin de fonctionner au quotidien (ex: aide pour les courses, le travail)." },
                    { id: 'aut9', text: "J'ai des routines si rigides que tout changement provoque une d√©tresse majeure et m'emp√™che de fonctionner." },
                    { id: 'aut10', text: "J'ai besoin d'une aide verbale ou non-verbale significative pour communiquer mes besoins essentiels." }
                ],
                extra: { id: 'aut_di', text: "Le profil concerne une personne avec une d√©ficience intellectuelle (DI) associ√©e." }
            },
            top: { title: 'Trouble Oppositionnel avec Provocation (TOP)', description: "Le TOP est caract√©ris√© par une humeur col√©rique/irritable persistante, un comportement querelleur/provocateur et un esprit vindicatif.", prevalence: "Affecte environ 1 √† 11% de la population, avec une moyenne autour de 3.3%.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'top1', text: "La personne se met souvent en col√®re." }, { id: 'top2', text: "Elle est souvent susceptible ou facilement agac√©e par les autres." }, { id: 'top3', text: "Elle est souvent f√¢ch√©e et pleine de ressentiment." }, { id: 'top4', text: "Elle conteste souvent ce que disent les figures d'autorit√©." }, { id: 'top5', text: "Elle s'oppose activement ou refuse de se plier aux demandes ou aux r√®gles." }, { id: 'top6', text: "Elle emb√™te d√©lib√©r√©ment les autres." }, { id: 'top7', text: "Elle fait souvent porter sur autrui la responsabilit√© de ses erreurs ou de sa mauvaise conduite." }, { id: 'top8', text: "S'est montr√©e m√©chante ou vindicative au moins deux fois lors des 6 derniers mois." } ] },
            conduct: { title: 'Trouble des Conduites', description: "Le trouble des conduites est un ensemble de comportements r√©p√©titifs et persistants dans lequel sont bafou√©s les droits fondamentaux d'autrui ou les normes et r√®gles sociales correspondant √† l'√¢ge.", prevalence: "La pr√©valence sur un an varie de 2 √† plus de 10%, avec une m√©diane de 4%.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'cd1', text: "Agressions envers des personnes ou des animaux (intimidation, menace, cruaut√© physique)." }, { id: 'cd2', text: "A souvent initi√© des bagarres." }, { id: 'cd3', text: "A utilis√© une arme pouvant blesser gravement autrui (b√¢ton, brique, couteau, arme √† feu)." }, { id: 'cd4', text: "Destruction de biens (a d√©lib√©r√©ment mis le feu, a d√©truit le bien d'autrui)." }, { id: 'cd5', text: "Fraude ou vol (a menti pour obtenir des biens, a vol√© des objets de valeur sans confrontation)." }, { id: 'cd6', text: "Violations graves des r√®gles √©tablies (reste dehors la nuit malgr√© les interdictions, a fait une fugue)." } ] },
            intermittent: { title: 'Trouble Explosif Intermittent', description: "Caract√©ris√© par des crises de col√®re ou d'agressivit√© impulsives et r√©currentes, nettement disproportionn√©es par rapport √† la provocation.", prevalence: "La pr√©valence sur un an est d'environ 2.7% dans la population g√©n√©rale.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'ie1', text: "A des crises d'agressivit√© verbale (col√®re, disputes) plusieurs fois par semaine." }, { id: 'ie2', text: "A des crises comportementales impliquant des dommages mat√©riels ou des agressions physiques (sans blessure grave) plusieurs fois par an." }, { id: 'ie3', text: "Le niveau d'agressivit√© exprim√© est manifestement hors de proportion avec la provocation." }, { id: 'ie4', text: "Les crises ne sont pas pr√©m√©dit√©es et sont de nature impulsive." }, { id: 'ie5', text: "Ces crises entra√Ænent une d√©tresse marqu√©e ou une alt√©ration du fonctionnement." } ] },
            antisocial: { title: 'Personnalit√© Antisociale', description: "Mode g√©n√©ral de m√©pris et de transgression des droits d'autrui qui appara√Æt d√®s l'adolescence.", prevalence: "Entre 0.2% et 3.3% de la population g√©n√©rale.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'as1', text: "Incapacit√© √† se conformer aux normes sociales et l√©gales (comportements d√©lictueux r√©p√©t√©s)." }, { id: 'as2', text: "Tendance √† tromper par profit ou par plaisir (mensonges r√©p√©t√©s, escroqueries)." }, { id: 'as3', text: "Impulsivit√© ou incapacit√© √† planifier √† l'avance." }, { id: 'as4', text: "Irritabilit√© et agressivit√© (bagarres ou agressions r√©p√©t√©es)." }, { id: 'as5', text: "M√©pris inconsid√©r√© pour sa s√©curit√© ou celle d'autrui." }, { id: 'as6', text: "Irresponsabilit√© persistante (incapacit√© √† assumer un emploi stable ou des obligations financi√®res)." }, { id: 'as7', text: "Absence de remords (indiff√©rence ou rationalisation apr√®s avoir bless√©, maltrait√© ou vol√© autrui)." } ] },
            borderline: { title: 'Personnalit√© Borderline (ou Limite)', description: "Mode g√©n√©ral d'instabilit√© des relations interpersonnelles, de l'image de soi et des affects, avec une impulsivit√© marqu√©e.", prevalence: "Affecte 1.6% √† 5.9% de la population. Plus fr√©quent dans les populations cliniques (10-20%).", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'bpd1', text: "Efforts effr√©n√©s pour √©viter les abandons r√©els ou imagin√©s." }, { id: 'bpd2', text: "Relations interpersonnelles instables et intenses, alternant entre id√©alisation et d√©valorisation." }, { id: 'bpd3', text: "Perturbation de l'identit√© : instabilit√© marqu√©e et persistante de l'image ou de la notion de soi." }, { id: 'bpd4', text: "Impulsivit√© dans au moins deux domaines potentiellement dommageables (d√©penses, sexualit√©, toxicomanie, crises de boulimie)." }, { id: 'bpd5', text: "R√©p√©tition de comportements, de gestes ou de menaces suicidaires, ou d'automutilations." }, { id: 'bpd6', text: "Instabilit√© affective due √† une r√©activit√© marqu√©e de l'humeur (col√®re intense, irritabilit√©, anxi√©t√©)." }, { id: 'bpd7', text: "Sentiments chroniques de vide." }, { id: 'bpd8', text: "Col√®res intenses et inappropri√©es ou difficult√© √† contr√¥ler sa col√®re." }, { id: 'bpd9', text: "Survenue transitoire, dans des situations de stress, d'une id√©ation pers√©cutoire ou de sympt√¥mes dissociatifs s√©v√®res." } ] },
            narcissistic: { title: 'Personnalit√© Narcissique', description: "Mode g√©n√©ral de fantaisies ou de comportements grandioses, de besoin d'√™tre admir√© et de manque d'empathie.", prevalence: "Jusqu'√† 6.2% dans les √©tudes sur la population g√©n√©rale.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'npd1', text: "A un sens grandiose de sa propre importance (surestime ses r√©alisations, s'attend √† √™tre reconnu comme sup√©rieur)." }, { id: 'npd2', text: "Est absorb√© par des fantaisies de succ√®s illimit√©, de pouvoir, de splendeur, de beaut√© ou d'amour id√©al." }, { id: 'npd3', text: "Pense √™tre ¬´ sp√©cial ¬ª et unique et ne pouvoir √™tre compris que par des gens sp√©ciaux ou de haut niveau." }, { id: 'npd4', text: "A un besoin excessif d'√™tre admir√©." }, { id: 'npd5', text: "Pense que tout lui est d√ª : s'attend √† un traitement particuli√®rement favorable." }, { id: 'npd6', text: "Exploite l'autre dans les relations interpersonnelles : utilise autrui pour parvenir √† ses propres fins." }, { id: 'npd7', text: "Manque d'empathie : n'est pas dispos√© √† reconna√Ætre ou √† partager les sentiments et les besoins d'autrui." }, { id: 'npd8', text: "Envie souvent les autres, ou croit que les autres l'envient." }, { id: 'npd9', text: "Fait preuve d'attitudes et de comportements arrogants et hautains." } ] },
            ocpd: { title: 'Personnalit√© Obsessionnelle-Compulsive (POC)', description: "Pr√©occupation pour l'ordre, le perfectionnisme et le contr√¥le mental et interpersonnel, aux d√©pens de la souplesse, de l'ouverture et de l'efficacit√©. (√Ä ne pas confondre avec le TOC).", prevalence: "L'un des plus fr√©quents, estim√© entre 2.1% et 7.9% de la population g√©n√©rale.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'ocpd1', text: "Pr√©occupations pour les d√©tails, les r√®gles, les inventaires, l'organisation ou les plans, au point de perdre de vue l'objectif principal." }, { id: 'ocpd2', text: "Perfectionnisme qui entrave l'ach√®vement des t√¢ches." }, { id: 'ocpd3', text: "D√©votion excessive pour le travail et la productivit√©, √† l'exclusion des loisirs et des amiti√©s." }, { id: 'ocpd4', text: "Est trop consciencieux, scrupuleux et rigide sur des questions de morale, d'√©thique ou de valeurs." }, { id: 'ocpd5', text: "Incapacit√© de jeter des objets us√©s ou sans valeur m√™me si ceux-ci n'ont pas de valeur sentimentale." }, { id: 'ocpd6', text: "R√©ticence √† d√©l√©guer des t√¢ches ou √† travailler avec autrui √† moins que les autres se soumettent exactement √† sa mani√®re de faire." }, { id: 'ocpd7', text: "Se montre avare avec l'argent pour soi-m√™me et les autres ; l'argent est per√ßu comme quelque chose qui doit √™tre accumul√© en vue de catastrophes futures." }, { id: 'ocpd8', text: "Se montre rigide et t√™tu." } ] },
            child_top: { title: 'Trouble Oppositionnel (Enfant)', description: "Comportements n√©gatifs, hostiles et provocateurs r√©p√©t√©s envers les figures d'autorit√©, inappropri√©s pour l'√¢ge de l'enfant.", prevalence: "Environ 3.3%, mais peut varier de 1 √† 11%. Le diagnostic doit tenir compte du stade de d√©veloppement de l'enfant.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'ctop1', text: "L'enfant se met souvent en col√®re ou est irritable." }, { id: 'ctop2', text: "Conteste ou refuse activement de se plier aux demandes des adultes." }, { id: 'ctop3', text: "Emb√™te d√©lib√©r√©ment les autres." }, { id: 'ctop4', text: "Accuse les autres pour ses propres erreurs." }, { id: 'ctop5', text: "Est souvent susceptible ou facilement agac√©." } ] },
            child_conduct: { title: 'Troubles des Conduites (Enfant)', description: "Comportements graves et persistants qui violent les droits des autres ou les normes sociales majeures pour son √¢ge.", prevalence: "Environ 4%. Peut √™tre plus √©lev√© chez les gar√ßons.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'ccd1', text: "Agressivit√© physique envers les pairs ou les animaux." }, { id: 'ccd2', text: "Mensonges r√©p√©t√©s pour √©viter des obligations ou obtenir des faveurs." }, { id: 'ccd3', text: "Vols (√† la maison, √† l'√©cole) sans confrontation." }, { id: 'ccd4', text: "Destruction d√©lib√©r√©e de biens appartenant √† autrui." }, { id: 'ccd5', text: "Violations graves des r√®gles (ex: fugues, absent√©isme scolaire pr√©coce)." } ] },
            child_anxiety: { title: 'Anxi√©t√© avec Comportements √âvitants (Enfant)', description: "Anxi√©t√© intense et persistante qui pousse l'enfant √† √©viter des situations sp√©cifiques (√©cole, interactions sociales), impactant son d√©veloppement.", prevalence: "Les troubles anxieux touchent environ 7% des enfants et adolescents.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'canx1', text: "Refuse fr√©quemment d'aller √† l'√©cole ou exprime une d√©tresse intense √† cette id√©e." }, { id: 'canx2', text: "√âvite les activit√©s de groupe ou les f√™tes d'anniversaire." }, { id: 'canx3', text: "Se plaint souvent de maux de ventre ou de t√™te, surtout avant des √©v√©nements sociaux ou scolaires." }, { id: 'canx4', text: "S'isole ou a tr√®s peu d'amis proches." }, { id: 'canx5', text: "Montre une timidit√© extr√™me qui l'emp√™che de participer en classe ou de demander de l'aide." } ] },
            child_eating: { title: 'Troubles Alimentaires Pr√©coces (Enfant)', description: "Comportements alimentaires inhabituels ou restrictifs qui ne sont pas expliqu√©s par une autre condition m√©dicale et qui impactent la sant√© ou le fonctionnement psychosocial.", prevalence: "Difficile √† estimer, mais les comportements alimentaires probl√©matiques sont courants dans la petite enfance.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'ceat1', text: "S√©lectivit√© alimentaire extr√™me (n'accepte qu'un tr√®s petit nombre d'aliments)." }, { id: 'ceat2', text: "Refus de s'alimenter conduisant √† une perte de poids ou √† une incapacit√© √† atteindre le poids attendu." }, { id: 'ceat3', text: "Peur intense de s'√©touffer ou de vomir qui interf√®re avec l'alimentation." }, { id: 'ceat4', text: "Manque d'int√©r√™t apparent pour la nourriture ou l'alimentation." }, { id: 'ceat5', text: "L'alimentation est une source majeure de conflit et de stress au quotidien." } ] },
            social_phobia: { title: 'Phobie Sociale (Trouble d\'Anxi√©t√© Sociale)', description: "Peur ou anxi√©t√© intenses d'une ou plusieurs situations sociales durant lesquelles le sujet est expos√© √† l'√©ventuelle observation attentive d'autrui.", prevalence: "La pr√©valence sur 12 mois est d'environ 7% aux √âtats-Unis et 2.3% en Europe. Pr√©valence √† vie d'environ 5 √† 12%.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'sp1', text: "Craint les situations o√π il/elle pourrait √™tre jug√©(e) n√©gativement." }, { id: 'sp2', text: "√âvite de parler √† des inconnus ou de prendre la parole en public." }, { id: 'sp3', text: "Les situations sociales provoquent presque toujours une peur ou une anxi√©t√©." }, { id: 'sp4', text: "La peur ou l'anxi√©t√© est disproportionn√©e par rapport √† la menace r√©elle pos√©e par la situation." }, { id: 'sp5', text: "L'√©vitement ou l'anxi√©t√© interf√®re de mani√®re significative avec la routine, le travail ou la vie sociale." } ] },
            ocd: { title: 'TOC (Trouble Obsessionnel-Compulsif)', description: "Pr√©sence d'obsessions (pens√©es intrusives et r√©currentes) et/ou de compulsions (comportements r√©p√©titifs ou actes mentaux) visant √† neutraliser l'anxi√©t√©.", prevalence: "La pr√©valence sur la vie est estim√©e entre 2% et 3%.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'ocd1', text: "A des pens√©es, pulsions ou images r√©currentes et persistantes qui sont ressenties comme intrusives et non d√©sir√©es (obsessions)." }, { id: 'ocd2', text: "Tente d'ignorer ou de neutraliser ces pens√©es par d'autres pens√©es ou actions." }, { id: 'ocd3', text: "Se sent pouss√©(e) √† accomplir des comportements r√©p√©titifs (lavage des mains, v√©rifications) ou des actes mentaux (prier, compter) en r√©ponse √† une obsession (compulsions)." }, { id: 'ocd4', text: "Les obsessions ou compulsions prennent beaucoup de temps (plus d'une heure par jour)." }, { id: 'ocd5', text: "Ces sympt√¥mes causent une d√©tresse ou une alt√©ration cliniquement significative du fonctionnement." } ] },
            eating_disorder: { title: 'Troubles Alimentaires (Anorexie, Boulimie, Hyperphagie)', description: "Perturbation persistante de l'alimentation ou du comportement li√© √† l'alimentation entra√Ænant une alt√©ration de la consommation ou de l'absorption de la nourriture et une alt√©ration significative de la sant√© physique ou du fonctionnement psychosocial.", prevalence: "Varie selon le trouble. Anorexie ‚âà0.4%, Boulimie ‚âà1-1.5%, Hyperphagie ‚âà1.6-3.5% (femmes).", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'ed1', text: "Restriction des apports √©nerg√©tiques conduisant √† un poids significativement bas." }, { id: 'ed2', text: "Peur intense de prendre du poids ou de devenir gros, ou comportement persistant qui interf√®re avec la prise de poids." }, { id: 'ed3', text: "Alt√©ration de la perception du poids ou de la forme de son propre corps." }, { id: 'ed4', text: "Survenue r√©currente d'acc√®s hyperphagiques (consommation d'une grande quantit√© de nourriture en un temps limit√© avec un sentiment de perte de contr√¥le)." }, { id: 'ed5', text: "Comportements compensatoires inappropri√©s et r√©currents visant √† pr√©venir la prise de poids (vomissements, laxatifs, exercice excessif)." } ] },
            addiction: { title: 'Troubles li√©s aux Addictions', description: "Ensemble de sympt√¥mes cognitifs, comportementaux et physiologiques indiquant qu'un individu continue d'utiliser une substance ou un comportement malgr√© des probl√®mes significatifs.", prevalence: "Tr√®s variable. Par exemple, trouble li√© √† l'usage d'alcool : environ 5.3% des adultes.", scaleText: FREQUENCY_SCALE_TEXT, items: [ { id: 'add1', text: "La substance/comportement est souvent utilis√©(e) en quantit√© plus importante ou pendant une p√©riode plus prolong√©e que pr√©vu." }, { id: 'add2', text: "D√©sir persistant ou efforts infructueux pour diminuer ou contr√¥ler l'utilisation." }, { id: 'add3', text: "Beaucoup de temps est pass√© √† des activit√©s n√©cessaires pour obtenir, utiliser la substance ou se remettre de ses effets." }, { id: 'add4', text: "Envie imp√©rieuse (craving), ou besoin urgent d'utiliser." }, { id: 'add5', text: "Utilisation r√©currente entra√Ænant l'incapacit√© de remplir des obligations majeures (travail, √©cole, maison)." }, { id: 'add6', text: "Utilisation continue malgr√© des probl√®mes interpersonnels ou sociaux persistants caus√©s par les effets de la substance/comportement." }, { id: 'add7', text: "Activit√©s sociales, professionnelles ou de loisirs importantes abandonn√©es ou r√©duites." }, { id: 'add8', text: "Besoin de quantit√©s notablement plus fortes pour obtenir l'effet d√©sir√© (tol√©rance)." } ] },
            
            // == NOUVEAUX MODULES ==
            big_five: {
                title: "Big Five (OCEAN)",
                scaleText: AGREEMENT_SCALE_TEXT,
                items: [
                    { id: 'bf1', trait: 'O', text: "Je suis curieux(se) et j'aime les exp√©riences nouvelles." },
                    { id: 'bf2', trait: 'C', text: "Je suis une personne organis√©e et fiable." },
                    { id: 'bf3', trait: 'E', text: "Je suis sociable et plein(e) d'√©nergie." },
                    { id: 'bf4', trait: 'A', text: "Je suis compatissant(e) et coop√©ratif(ve)." },
                    { id: 'bf5', trait: 'N', text: "Je suis souvent anxieux(se) ou de mauvaise humeur." },
                    { id: 'bf6', trait: 'O', text: "Je pr√©f√®re la routine et ce qui m'est familier.", reverse: true },
                    { id: 'bf7', trait: 'C', text: "J'ai tendance √† √™tre d√©sorganis√©(e) et impulsif(ve).", reverse: true },
                    { id: 'bf8', trait: 'E', text: "Je suis plut√¥t r√©serv√©(e) et solitaire.", reverse: true },
                    { id: 'bf9', trait: 'A', text: "J'ai tendance √† √™tre critique et m√©fiant(e) envers les autres.", reverse: true },
                    { id: 'bf10', trait: 'N', text: "Je suis g√©n√©ralement calme et √©motionnellement stable.", reverse: true }
                ]
            },
            locus_of_control: {
                title: "Locus de Contr√¥le",
                scaleText: AGREEMENT_SCALE_TEXT,
                items: [
                    { id: 'lc1', type: 'ext', text: "Ce qui m'arrive est souvent une question de chance." },
                    { id: 'lc2', type: 'int', text: "Je suis le principal artisan de mon succ√®s." },
                    { id: 'lc3', type: 'ext', text: "Je n'ai que peu d'influence sur la fa√ßon dont les autres se comportent." },
                    { id: 'lc4', type: 'int', text: "En g√©n√©ral, je peux atteindre les objectifs que je me fixe." },
                    { id: 'lc5', type: 'ext', text: "Souvent, je me sens impuissant(e) face aux √©v√©nements mondiaux." },
                    { id: 'lc6', type: 'int', text: "Quand je fais des plans, je suis presque certain(e) de pouvoir les r√©aliser." }
                ]
            },
            grit: {
                title: "√âchelle de 'Grit' (Pers√©v√©rance et Passion)",
                scaleText: AGREEMENT_SCALE_TEXT,
                items: [
                    { id: 'gr1', text: "Les nouvelles id√©es et projets me distraient parfois de mes objectifs pr√©c√©dents.", reverse: true },
                    { id: 'gr2', text: "Les √©checs ne me d√©couragent pas ; je n'abandonne pas." },
                    { id: 'gr3', text: "Je suis un travailleur acharn√©." },
                    { id: 'gr4', text: "J'ai des difficult√©s √† maintenir ma concentration sur des projets qui prennent plus de quelques mois √† compl√©ter.", reverse: true },
                    { id: 'gr5', text: "J'ai surmont√© des revers pour conqu√©rir un d√©fi important." }
                ]
            },
            thinking_styles: {
                title: "Styles de Pens√©e (Distorsions Cognitives)",
                scaleText: FREQUENCY_SCALE_TEXT,
                items: [
                    { id: 'ts1', text: "Pens√©e 'Tout ou Rien' : Je vois les choses en noir et blanc (ex: 'Si je ne suis pas parfait, je suis un √©chec')." },
                    { id: 'ts2', text: "Surg√©n√©ralisation : Je conclus √† un sch√©ma n√©gatif global √† partir d'un seul √©v√©nement (ex: 'J'ai rat√© cet entretien, je ne trouverai jamais de travail')." },
                    { id: 'ts3', text: "Filtre Mental : Je me concentre uniquement sur les aspects n√©gatifs et j'ignore les positifs." },
                    { id: 'ts4', text: "Disqualification du Positif : Je transforme les exp√©riences positives en exp√©riences neutres ou n√©gatives (ex: 'J'ai r√©ussi, mais c'√©tait de la chance')." },
                    { id: 'ts5', text: "Conclusions H√¢tives (Lecture de pens√©e / Erreur de pr√©diction) : Je suppose le pire sans preuve (ex: 'Il pense que je suis incomp√©tent' ou 'Je sais que je vais rater')." },
                    { id: 'ts6', text: "Catastrophisation : J'exag√®re l'importance des probl√®mes et j'anticipe une catastrophe." },
                    { id: 'ts7', text: "Raisonnement √âmotionnel : Je crois que mes √©motions refl√®tent la r√©alit√© (ex: 'Je me sens stupide, donc je dois l'√™tre')." },
                    { id: 'ts8', text: "Les 'Je dois' et 'Il faut' : J'ai des r√®gles rigides sur la fa√ßon dont moi-m√™me et les autres devrions nous comporter." },
                    { id: 'ts9', text: "Personnalisation : Je me bl√¢me pour des √©v√©nements qui ne sont pas enti√®rement de ma faute." }
                ]
            },
            alexithymia: {
                title: "Alexithymie (Difficult√© √† identifier/d√©crire les √©motions)",
                scaleText: AGREEMENT_SCALE_TEXT,
                items: [
                    { id: 'al1', text: "J'ai souvent du mal √† trouver les mots justes pour d√©crire mes sentiments." },
                    { id: 'al2', text: "Je suis souvent perplexe face aux sensations qui agitent mon corps." },
                    { id: 'al3', text: "Je pr√©f√®re analyser les probl√®mes plut√¥t que de d√©crire les √©motions qu'ils suscitent." },
                    { id: 'al4', text: "Je ne sais pas ce qui se passe en moi." },
                    { id: 'al5', text: "Les gens me disent de d√©crire davantage mes sentiments." }
                ]
            }
        };

        const DESCRIPTIONS = {
            mbti: {
                'INTJ': 'L\'Architecte : Penseur strat√©gique et imaginatif. Les INTJ ont un plan pour tout et √©valuent syst√©matiquement les situations pour atteindre leurs objectifs. Ils sont ind√©pendants, rationnels et pr√©f√®rent la logique √† l\'√©motion. Tr√®s exigeants envers eux-m√™mes et les autres, ils visent l\'efficacit√© et l\'excellence.\n- Signes et sympt√¥mes : Pr√©f√©rence pour la planification √† long terme, analyse approfondie avant d\'agir, tendance √† se d√©tacher √©motionnellement, confiance en soi solide mais discr√®te, peu tol√©rants aux inefficacit√©s.',
                'INTP': 'Le Logicien : Inventeur innovant avec une soif de connaissance in√©puisable. Les INTP sont des penseurs abstraits qui aiment explorer des id√©es complexes et th√©oriques. Ils sont curieux, ind√©pendants et souvent non conventionnels dans leur approche intellectuelle.\n- Signes et sympt√¥mes : Remise en question constante des id√©es √©tablies, tendance √† r√©fl√©chir profond√©ment, expression parfois distante, int√©r√™t marqu√© pour la logique et la th√©orie, cr√©ativit√© cognitive.',
                'ENTJ': 'Le Commandant : Leader audacieux, imaginatif et dot√© d\'une forte volont√©. Les ENTJ trouvent toujours un moyen d\'arriver √† leurs fins et inspirent confiance autour d\'eux. Ils sont charismatiques, organis√©s et orient√©s r√©sultats.\n- Signes et sympt√¥mes : Capacit√© de leadership naturelle, planification strat√©gique, assertivit√© √©lev√©e, confiance en soi marqu√©e, peu tol√©rants aux inefficacit√©s et √† la passivit√©.',
                'ENTP': 'L\'Innovateur : Penseur astucieux et curieux qui adore relever des d√©fis intellectuels. Les ENTP d√©construisent et reconstruisent les id√©es pour le plaisir, innovent constamment et aiment explorer les possibilit√©s.\n- Signes et sympt√¥mes : Pens√©e divergente, cr√©ativit√© √©lev√©e, enthousiasme pour les d√©bats, tendance √† prendre des risques intellectuels, adaptabilit√© rapide.',
                'INFJ': 'L\'Avocat : Id√©aliste calme et mystique, mais tr√®s inspirant et infatigable. Les INFJ sont guid√©s par un sens profond de l\'id√©al et de la moralit√©, avec une vision claire de ce qui est juste. Ils peuvent √™tre r√©serv√©s mais profond√©ment empathiques.\n- Signes et sympt√¥mes : Sensibilit√© aux √©motions des autres, intuition d√©velopp√©e, vision √† long terme, forte motivation morale, capacit√© √† guider les autres de mani√®re discr√®te.',
                'INFP': 'Le M√©diateur : Po√©tique, gentil et altruiste. Les INFP sont motiv√©s par leurs valeurs et leur id√©alisme, et cherchent toujours √† aider les causes justes. Ils poss√®dent une vie int√©rieure riche et une cr√©ativit√© √©motionnelle prononc√©e.\n- Signes et sympt√¥mes : Empathie forte, r√©flexion introspective, cr√©ativit√© artistique ou verbale, tendance √† √©viter les conflits, passion pour les causes personnelles.',
                'ENFJ': 'Le Protagoniste : Leader charismatique et inspirant, capable de fasciner son auditoire. Les ENFJ utilisent leur √©nergie pour aider et motiver les autres, tout en d√©fendant des valeurs morales √©lev√©es.\n- Signes et sympt√¥mes : Communication persuasive, charisme naturel, souci des autres, capacit√© √† inspirer et organiser, sens aigu de l\'√©thique.',
                'ENFP': 'L\'Inspirateur : Esprit libre enthousiaste, cr√©atif et sociable. Les ENFP sont curieux, charmants et compatissants, capables de s\'adapter √† de nombreuses situations sociales et de g√©n√©rer de nouvelles id√©es avec enthousiasme.\n- Signes et sympt√¥mes : Sociabilit√© √©lev√©e, cr√©ativit√© d√©bordante, curiosit√© insatiable, enthousiasme contagieux, capacit√© √† motiver les autres.',
                'ISTJ': 'Le Logisticien : Individu pratique, m√©thodique et fiable, dont la loyaut√© et la discipline sont in√©branlables. Les ISTJ appr√©cient l‚Äôordre, les r√®gles et la structure.\n- Signes et sympt√¥mes : Forte organisation, respect des traditions, sens des responsabilit√©s, attention aux d√©tails, fiabilit√© constante.',
                'ISFJ': 'Le D√©fenseur : Protecteur d√©vou√© et chaleureux, toujours pr√™t √† soutenir ses proches. Les ISFJ combinent sens pratique et empathie, avec un grand sens du devoir.\n- Signes et sympt√¥mes : Altruisme concret, m√©moire des besoins des autres, tendance √† soutenir plut√¥t que diriger, loyaut√© et patience, sens aigu du d√©tail.',
                'ESTJ': 'Le Directeur : Administrateur efficace et organis√©, excellent pour g√©rer les personnes et les t√¢ches. Les ESTJ sont attach√©s √† l‚Äôordre, aux r√®gles et √† la responsabilit√©.\n- Signes et sympt√¥mes : Autorit√© naturelle, sens de l‚Äôorganisation, prise de d√©cision rapide, respect des r√®gles et de la hi√©rarchie, pragmatisme √©lev√©.',
                'ESFJ': 'Le Consul : Personne attentionn√©e, sociable et populaire. Les ESFJ se soucient profond√©ment des autres et prosp√®rent dans la coop√©ration sociale.\n- Signes et sympt√¥mes : Sociabilit√© intense, altruisme social, conscience des normes et traditions, capacit√© √† organiser et soutenir les groupes, sensibilit√© aux besoins des autres.',
                'ISTP': 'Le Virtuose : Exp√©rimentateur audacieux et pratique, ma√Ætre de ses mains et de ses outils. Les ISTP aiment explorer le monde par l‚Äôaction directe.\n- Signes et sympt√¥mes : Habilet√© technique, curiosit√© pratique, pr√©f√©rence pour l‚Äôaction sur la th√©orie, ind√©pendance, flexibilit√© dans la r√©solution de probl√®mes.',
                'ISFP': 'L\'Aventurier : Artiste flexible et charmant, toujours pr√™t √† exp√©rimenter et explorer. Les ISFP vivent dans un monde sensoriel riche et appr√©cient la beaut√© autour d‚Äôeux.\n- Signes et sympt√¥mes : Sensibilit√© esth√©tique, spontan√©it√©, cr√©ativit√© pratique, empathie discr√®te, capacit√© √† vivre le moment pr√©sent.',
                'ESTP': 'L\'Entrepreneur : Intelligent, √©nergique et perspicace. Les ESTP aiment l‚Äôaction, le risque et √™tre au centre de l‚Äôattention.\n- Signes et sympt√¥mes : Audace sociale, r√©activit√© rapide, esprit pratique et pragmatique, recherche de sensations, charisme direct.',
                'ESFP': 'L\'Amuseur : Spontan√©, enthousiaste et dynamique. Les ESFP vivent pleinement le moment et aiment divertir les autres.\n- Signes et sympt√¥mes : Sociabilit√© √©lev√©e, √©nergie contagieuse, cr√©ativit√© dans l‚Äôaction, recherche de nouvelles exp√©riences, grande adaptabilit√©.'
            },
            enneagram: {
                1: 'Le Perfectionniste : Motiv√© par le besoin d\'√™tre bon, juste et int√®gre. Les Perfectionnistes luttent contre le mal et la corruption.\n- Signes et sympt√¥mes : Rigueur morale, sens √©lev√© du devoir, critique des erreurs, organisation m√©ticuleuse, tendance √† la frustration envers soi et les autres.',
                2: 'L\'Altruiste : Motiv√© par le besoin d\'√™tre aim√© et reconnu. Les Altruistes craignent d\'√™tre rejet√©s ou non appr√©ci√©s.\n- Signes et sympt√¥mes : Empathie active, tendance √† aider m√™me au d√©triment de soi, manipulation subtile pour maintenir l\'affection, besoin d\'√™tre valoris√©.',
                3: 'Le Battant : Motiv√© par le succ√®s et la reconnaissance. Les Battants redoutent l\'insignifiance.\n- Signes et sympt√¥mes : Comp√©titivit√©, souci de l\'image, ambition marqu√©e, adaptabilit√© sociale, difficult√© √† g√©rer l\'√©chec.',
                4: 'Le Romantique : Motiv√© par l\'individualit√© et l\'authenticit√©. Les Romantiques craignent l\'absence d\'identit√©.\n- Signes et sympt√¥mes : Sensibilit√© √©motionnelle intense, introspection, expression artistique, m√©lancolie, fluctuations d\'humeur.',
                5: 'L\'Observateur : Motiv√© par la compr√©hension et la comp√©tence. Les Observateurs craignent l\'inutilit√©.\n- Signes et sympt√¥mes : Retrait social, accumulation d\'informations, analyse excessive, d√©tachement √©motionnel, curiosit√© intellectuelle.',
                6: 'Le Loyaliste : Motiv√© par la s√©curit√© et le soutien. Les Loyalistes craignent d\'√™tre laiss√©s seuls.\n- Signes et sympt√¥mes : M√©fiance, anxi√©t√©, recherche de protection, fid√©lit√© marqu√©e, h√©sitation d√©cisionnelle.',
                7: 'L\'√âpicurien : Motiv√© par le plaisir et l\'√©vitement de la douleur. Les √âpicuriens craignent la privation.\n- Signes et sympt√¥mes : Enthousiasme, impulsivit√©, diversification des exp√©riences, fuite des √©motions n√©gatives, hyperactivit√© mentale.',
                8: 'Le Chef : Motiv√© par le contr√¥le et la protection. Les Chefs craignent la domination par autrui.\n- Signes et sympt√¥mes : Assertivit√©, domination, confrontation, ind√©pendance, tendance √† l\'intimidation.',
                9: 'Le M√©diateur : Motiv√© par la paix et l\'harmonie. Les M√©diateurs craignent la s√©paration.\n- Signes et sympt√¥mes : √âvitement des conflits, passivit√©, difficult√© √† affirmer ses besoins, tol√©rance √©lev√©e, tendance √† la procrastination.'
            },
            attachment: {
                secure: "Style S√©cure : Vision positive de soi et des autres. Capacit√© √† √™tre autonome tout en √©tant √† l'aise avec l'intimit√©. Communique ouvertement et g√®re bien les conflits.\n- Signes et sympt√¥mes : Confiance en soi, relations stables, expression √©motionnelle saine, adaptabilit√© sociale, √©quilibre entre d√©pendance et autonomie.",
                anxious_fused: "Style Anxieux/Fusionnel : Vision n√©gative de soi, positive des autres. Recherche de proximit√© constante et peur de l'abandon.\n- Signes et sympt√¥mes : Attachement intense, anxi√©t√© relationnelle, jalousie, besoin constant de r√©assurance, difficult√© √† g√©rer la solitude.",
                avoidant_fearful: "Style √âvitant/Craintif : Vision positive de soi, n√©gative des autres. Valorise l'ind√©pendance et √©vite l'intimit√©.\n- Signes et sympt√¥mes : Distance √©motionnelle, r√©ticence √† la vuln√©rabilit√©, autosuffisance, m√©fiance envers autrui, tendance √† fuir les relations profondes.",
                disorganized: "Style D√©sorganis√©/Chaotique : Vision n√©gative de soi et des autres. D√©sire l'intimit√© mais en a peur.\n- Signes et sympt√¥mes : Comportement contradictoire, oscillation entre rapprochement et rejet, peur de l'abandon, impulsivit√© relationnelle, anxi√©t√© intense."
            },
            otroverti: "√âquilibre entre extraversion et introversion. Adaptable aux contextes sociaux ou solitaires.\n- Signes et sympt√¥mes : Sociabilit√© mod√©r√©e, capacit√© √† profiter de la solitude, flexibilit√© sociale, adaptabilit√© √©motionnelle, √©quilibre entre r√©flexion et action.",
            antagonistic_traits: {
                mach: "Tendance √† manipuler et exploiter les autres pour atteindre des objectifs personnels, souvent via des strat√©gies froides et calcul√©es.\n- Pr√©sentation : Comportement instrumental o√π les relations sont vues comme des moyens d'obtenir des ressources, du statut ou des avantages.\n- Signes et sympt√¥mes : Flatterie int√©ress√©e, mensonges ou omissions planifi√©es, exploitation des faiblesses d'autrui, justification utilitariste des actions, faible expression de remords ou rationalisation apr√®s avoir nui.",
                narc: "Grandiosit√© et besoin persistant d'admiration accompagn√©s d'une sensibilit√© marqu√©e √† la critique. Le narcissisme implique une surestimation de soi et un centrage sur l'image personnelle.\n- Pr√©sentation : Recherche constante de reconnaissance et d'approbation, focalisation sur le prestige et l'apparence sociale.\n- Signes et sympt√¥mes : Exag√©ration des r√©ussites, attente de traitement pr√©f√©rentiel, tendance √† d√©valoriser ou instrumentaliser autrui pour maintenir l'image, d√©ficits empathiques, r√©actions d√©fensives ou agressives face aux critiques.",
                psy: "Traits associ√©s √† une insensibilit√© √©motionnelle et √† une propension √† l'impulsivit√© et aux comportements antisociaux graves.\n- Pr√©sentation : Difficult√© marqu√©e √† √©prouver culpabilit√©, empathie ou remords ; charme superficiel parfois utilis√© pour manipuler.\n- Signes et sympt√¥mes : Mensonges r√©p√©t√©s, tendance √† prendre des risques dangereux, indiff√©rence aux souffrances d'autrui, incapacit√© √† tirer des le√ßons des sanctions, comportement antisocial persistant et violation r√©p√©t√©e des normes.",
                soc: "Propension aux actes antisociaux et √† l'impulsivit√© avec un m√©pris fr√©quent des r√®gles sociales et des droits d'autrui.\n- Pr√©sentation : Comportement instable, attitudes agressives ou hostiles, difficult√©s soutenues √† maintenir obligations et relations.\n- Signes et sympt√¥mes : Acc√®s de col√®re violents ou impr√©visibles, comportements transgressifs (vols, vandalisme, agressions), irresponsabilit√© chronique, tendances √† bl√¢mer les autres et remords limit√©s."
            },
            autism: {
                level1: "Niveau 1 - 'N√©cessitant un soutien' : Difficult√©s notables dans la communication sociale n√©cessitant un soutien.\n- Signes observables : Difficult√© √† initier des interactions, r√©ponses atypiques aux tentatives sociales, int√©r√™t r√©duit pour les interactions.\n- Comportements restreints/r√©p√©titifs : Interf√®rent dans un ou plusieurs contextes, difficult√© √† changer d'activit√©, probl√®mes d'organisation.",
                level2: "Niveau 2 - 'N√©cessitant un soutien substantiel' : D√©ficits marqu√©s dans la communication sociale, m√™me avec soutien.\n- Signes observables : Initiation limit√©e aux interactions sociales, r√©ponses r√©duites ou anormales, langage simple, int√©r√™t restreint pour des sujets sp√©cifiques.\n- RRB : Fr√©quents et visibles, interf√®rent dans plusieurs contextes, d√©tresse en cas de changement.",
                level3: "Niveau 3 - 'N√©cessitant un soutien tr√®s substantiel' : D√©ficits s√©v√®res dans la communication sociale.\n- Signes observables : Initiation minimale des interactions, r√©ponses limit√©es aux autres, langage tr√®s r√©duit, m√©thodes inhabituelles pour satisfaire ses besoins.\n- RRB : Interf√®rent gravement avec le fonctionnement, d√©tresse marqu√©e si interrompus.",
                with_di: "Avec D√©ficience Intellectuelle (DI) associ√©e : La DI influence l'expression des traits autistiques.\n- Signes et sympt√¥mes : Communication encore plus limit√©e, autonomie r√©duite, besoin de strat√©gies de soutien adapt√©es pour TSA et DI."
            },
            big_five: {
                O: "Ouverture √† l'exp√©rience : Appr√©ciation de l'art, de l'aventure, des id√©es inhabituelles et de la curiosit√©.\n- Signes et sympt√¥mes : Imagination, cr√©ativit√©, curiosit√© intellectuelle, ouverture aux nouvelles exp√©riences, flexibilit√© mentale.",
                C: "Conscienciosit√© : Organisation, fiabilit√© et autodiscipline.\n- Signes et sympt√¥mes : Planification, pers√©v√©rance, fiabilit√©, sens du devoir, pr√©f√©rence pour les actions planifi√©es.",
                E: "Extraversion : √ânergie, sociabilit√© et assertivit√©.\n- Signes et sympt√¥mes : Enthousiasme, √©nergie sociale, recherche de stimulation, assertivit√©, positivit√© √©motionnelle.",
                A: "Agr√©abilit√© : Compassion et coop√©ration.\n- Signes et sympt√¥mes : Tol√©rance, empathie, comportement coop√©ratif, souci de l'harmonie sociale, altruisme.",
                N: "N√©vrosisme : Tendance aux √©motions n√©gatives et √† l'instabilit√© √©motionnelle.\n- Signes et sympt√¥mes : Anxi√©t√©, irritabilit√©, d√©pression, vuln√©rabilit√© √©motionnelle, sensibilit√© au stress."
            },
            locus_of_control: {
                internal: "Locus de Contr√¥le Interne : Croyance en la ma√Ætrise de sa vie.\n- Signes et sympt√¥mes : Prise de responsabilit√©, planification proactive, confiance en ses actions, faible externalisation des √©checs.",
                external: "Locus de Contr√¥le Externe : Croyance que la vie est contr√¥l√©e par des facteurs externes.\n- Signes et sympt√¥mes : Sentiment de fatalit√©, d√©pendance √† la chance ou au destin, tendance √† bl√¢mer les autres, passivit√© face aux d√©fis."
            },
            grit: "Maintien de l'effort et de l'int√©r√™t pour des objectifs √† long terme.\n- Signes et sympt√¥mes : Pers√©v√©rance malgr√© les √©checs, patience, discipline personnelle, motivation soutenue, r√©silience.",
            thinking_styles: "Sch√©mas de pens√©e irrationnels affectant la perception de la r√©alit√©.\n- Signes et sympt√¥mes : Pens√©e tout ou rien, g√©n√©ralisation excessive, catastrophisme, auto-d√©valorisation, raisonnement biais√©.",
            alexithymia: "Difficult√© √† identifier et d√©crire ses √©motions.\n- Signes et sympt√¥mes : Confusion √©motionnelle, difficult√© √† comprendre les sentiments des autres, pens√©e concr√®te et orient√©e vers l'ext√©rieur, communication √©motionnelle limit√©e."
        };



        /* ==================================== */
        /* == UI BUILDING & EVENT LISTENERS  == */
        /* ==================================== */

        function el(tag, opts = {}) { const e = document.createElement(tag); Object.assign(e, opts); return e; }
        
        function build() {
            buildModuleSelector();
            buildAllSections();
        }
        
        function buildModuleSelector() {
            const selectorContainer = document.getElementById('moduleSelector');
            selectorContainer.innerHTML = '';
            for (const key in MODULES) {
                const mod = MODULES[key];
                const lbl = el('label', { className: 'opt' });
                const checkbox = el('input', { 
                    type: 'checkbox', 
                    name: 'module', 
                    value: key, 
                    checked: mod.enabled,
                    onchange: () => toggleModule(key)
                });
                lbl.appendChild(checkbox);
                lbl.appendChild(el('span', { innerText: mod.title }));
                selectorContainer.appendChild(lbl);
            }
        }

        function toggleModule(key) {
            MODULES[key].enabled = !MODULES[key].enabled;
            buildAllSections();
        }

        function buildAllSections() {
            const container = document.getElementById('allSectionsContainer');
            container.innerHTML = '';

            for (const key in MODULES) {
                if (MODULES[key].enabled) {
                    MODULES[key].sections.forEach(sectionKey => {
                        const sectionData = SECTIONS_DATA[sectionKey];
                        if (sectionData) {
                            const sectionDiv = el('div', { id: `${sectionKey}Container`, style: 'margin-top:10px' });
                            sectionDiv.appendChild(el('div', { className: 'section-title', innerText: sectionData.title }));
                            
                            if (sectionKey === 'mbti') buildMbti(sectionDiv, sectionData);
                            else if (sectionKey === 'enneagram') buildEnneagram(sectionDiv, sectionData);
                            else if (sectionKey === 'attachment') buildAttachment(sectionDiv, sectionData);
                            else if (sectionKey === 'autism') buildAutism(sectionDiv, sectionData);
                            else if (sectionData.scaleText) buildScaleQuestions(sectionDiv, sectionData, sectionKey);
                            
                            container.appendChild(sectionDiv);
                        }
                    });
                }
            }
        }

        function buildMbti(container, data) {
             data.items.forEach((it, idx) => {
                const q = el('div', { className: 'q' });
                const mainQuestion = it.q.split(' : ')[0];
                const optionsText = it.q.split(' : ')[1] || '';
                const [optAText, optBText] = optionsText.split(' / ').map(t => t.replace(/\((A|B)\)\s*/, ''));

                q.appendChild(el('div', { innerText: (idx + 1) + '. ' + mainQuestion, style: 'font-weight:600;margin-bottom:6px' }));
                const opts = el('div', { className: 'options' });

                const lblA = el('label', { className: 'opt' });
                lblA.innerHTML = `<input type="radio" name="${it.id}" value="A"> <span>${optAText}</span>`;
                opts.appendChild(lblA);

                const lblB = el('label', { className: 'opt' });
                lblB.innerHTML = `<input type="radio" name="${it.id}" value="B"> <span>${optBText}</span>`;
                opts.appendChild(lblB);
                q.appendChild(opts); container.appendChild(q);
            });
        }
        
        function buildEnneagram(container, data) {
            container.appendChild(el('div', { innerHTML: '<strong>Motivation / Peur centrale (choisir la plus proche)</strong>', style: 'margin-bottom:6px' }));
            data.items.main.forEach(it => {
                const lbl = el('label', { className: 'opt' });
                lbl.innerHTML = `<input type="radio" name="ennea_main" value="${it.type}"> <span>${it.text}</span>`;
                container.appendChild(lbl);
            });
            container.appendChild(el('div', { innerHTML: '<strong style="margin-top:12px;display:block">Comportements sous stress (cocher si observ√©)</strong>' }));
            data.items.stress.forEach(it => { const lbl = el('label', { className: 'opt' }); lbl.innerHTML = `<input type="checkbox" name="ennea_stress" value="${it.type}"> <span>${it.text}</span>`; container.appendChild(lbl); });
            container.appendChild(el('div', { innerHTML: '<strong style="margin-top:12px;display:block">Instinct dominant</strong>' }));
            data.items.instincts.forEach(it => { const lbl = el('label', { className: 'opt' }); lbl.innerHTML = `<input type="radio" name="instinct" value="${it.id}"> <span>${it.text}</span>`; container.appendChild(lbl); });
        }
        
        function buildAttachment(container, data) {
            data.items.forEach(it => { const lbl = el('label', { className: 'opt' }); lbl.innerHTML = `<input type="radio" name="attachment" value="${it.val}"> <span>${it.text}</span>`; container.appendChild(lbl); });
        }
        
        function buildAutism(container, data) {
            buildScaleQuestions(container, data, 'autism'); // Build standard scale questions
            if (data.extra) { // Add the extra checkbox
                const q = el('div', { className: 'q' });
                const lbl = el('label', { className: 'opt' });
                lbl.innerHTML = `<input type="checkbox" name="${data.extra.id}"> <span>${data.extra.text}</span>`;
                q.appendChild(lbl);
                container.appendChild(q);
            }
        }

        function buildScaleQuestions(container, data, sectionKey) {
            container.appendChild(el('div', { innerHTML: data.scaleText, style: 'font-size:12px;color:var(--text-secondary);margin-bottom:6px' }));
            data.items.forEach((it, idx) => {
                const q = el('div', { className: 'q' });
                q.appendChild(el('div', { innerText: (idx + 1) + '. ' + it.text, style: 'font-weight:600;margin-bottom:6px' }));
                const row = el('div', { className: 'options' });
                const isRange = data.scaleText === AGREEMENT_SCALE_TEXT;
                const min = isRange ? 1 : 0;
                const max = isRange ? 5 : 4;
                const value = isRange ? 1 : 0;
                row.innerHTML = `${min} <input type="range" name="${sectionKey}_${it.id}" min="${min}" max="${max}" value="${value}"> ${max}`;
                q.appendChild(row); container.appendChild(q);
            });
        }
        
        /* ======================== */
        /* == ANALYSIS FUNCTIONS == */
        /* ======================== */
        
        function analyzeAllEnabledSections() {
            const results = {};
            for (const modKey in MODULES) {
                if (MODULES[modKey].enabled) {
                    MODULES[modKey].sections.forEach(secKey => {
                        const analyzer = `analyze${secKey.charAt(0).toUpperCase() + secKey.slice(1)}`;
                        if (window[analyzer]) {
                            results[secKey] = window[analyzer]();
                        } else if (SECTIONS_DATA[secKey] && SECTIONS_DATA[secKey].scaleText) {
                            results[secKey] = analyzeSection(secKey);
                        }
                    });
                }
            }
            return results;
        }

        function analyzeSection(sectionKey) {
            if (!SECTIONS_DATA[sectionKey]) return null;
            const data = SECTIONS_DATA[sectionKey];
            let totalScore = 0;
            const isAgreementScale = data.scaleText === AGREEMENT_SCALE_TEXT;
            const min = isAgreementScale ? 1 : 0;
            const max = isAgreementScale ? 5 : 4;
            const maxScore = data.items.length * max;
            const minScore = data.items.length * min;

            data.items.forEach(item => {
                const input = document.querySelector(`input[name="${sectionKey}_${item.id}"]`);
                if (input) {
                    let value = parseInt(input.value, 10);
                    if (item.reverse) {
                        value = (max + min) - value;
                    }
                    totalScore += value;
                }
            });

            if (maxScore - minScore === 0) return { score: 0, percentage: 0, ...data };
            const percentage = Math.round(((totalScore - minScore) / (maxScore - minScore)) * 100);
            return { score: totalScore, maxScore: maxScore, percentage: percentage, ...data };
        }

        function analyzeMbti() {
            const counts = { I: 0, E: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
            SECTIONS_DATA.mbti.items.forEach(it => {
                const sel = document.querySelector(`input[name="${it.id}"]:checked`);
                if (sel) { const letter = sel.value === 'A' ? it.A : it.B; counts[letter]++; }
            });
            function decide(a, b) {
                const ca = counts[a], cb = counts[b];
                if (ca === 0 && cb === 0) return { letter: 'X', confidence: 0 };
                const letter = ca >= cb ? a : b;
                const confidence = Math.round(Math.abs(ca - cb) / 3 * 100);
                return { letter, confidence };
            }
            const ie = decide('I', 'E'), sn = decide('S', 'N'), tf = decide('T', 'F'), jp = decide('J', 'P');
            const type = ie.letter + sn.letter + tf.letter + jp.letter;
            const globalConf = Math.round((ie.confidence + sn.confidence + tf.confidence + jp.confidence) / 4);
            return { type, breakdown: { ie, sn, tf, jp }, globalConf };
        }

        function analyzeEnneagram() {
            const main = document.querySelector('input[name="ennea_main"]:checked');
            const type = main ? parseInt(main.value, 10) : null;
            const stresses = Array.from(document.querySelectorAll('input[name="ennea_stress"]:checked')).map(n => parseInt(n.value, 10));
            const scores = {};
            for (let i = 1; i <= 9; i++) scores[i] = 0;
            if (type) scores[type] += 3;
            stresses.forEach(t => { if (scores[t] !== undefined) scores[t] += 1; });
            const sorted = Object.keys(scores).map(k => ({ type: parseInt(k, 10), score: scores[k] })).sort((a, b) => b.score - a.score);
            const top = sorted[0] || null;
            let wing = null;
            if (type) {
                const wing1 = type === 1 ? 9 : type - 1;
                const wing2 = type === 9 ? 1 : type + 1;
                const score1 = stresses.includes(wing1) ? 1 : 0;
                const score2 = stresses.includes(wing2) ? 1 : 0;
                if (score1 > score2) wing = wing1;
                else if (score2 > score1) wing = wing2;
            }
            const inst = document.querySelector('input[name="instinct"]:checked');
            const instMap = { sp: 'Auto-pr√©servation', so: 'Social', sx: 'Sexuel (T√™te-√†-t√™te)' };
            return { type, top, wing, instinct: inst ? instMap[inst.value] : null, scores };
        }

        function analyzeAntagonistic_traits() {
            const traits = { mach: 0, narc: 0, psy: 0, soc: 0 };
            const data = SECTIONS_DATA.antagonistic_traits.items;
            data.forEach(it => {
                const el = document.querySelector(`input[name="antagonistic_traits_${it.id}"]`);
                if(el && traits[it.group] !== undefined) {
                    traits[it.group] += parseInt(el.value, 10);
                }
            });
            // Each trait has 3 questions ranging from 1 to 5. Min score is 3, max is 15. Range is 12.
            const toPct = (score) => Math.round((score - 3) / 12 * 100);
            return { 
                mach: toPct(traits.mach), 
                narc: toPct(traits.narc), 
                psy: toPct(traits.psy),
                soc: toPct(traits.soc)
            };
        }

        function analyzeAttachment() {
            const sel = document.querySelector('input[name="attachment"]:checked');
            const map = { secure: 'S√©cure', anxious_fused: 'Anxieux/Fusionnel', avoidant_fearful: '√âvitant/Craintif', disorganized: 'D√©sorganis√©/Chaotique' };
            return { raw: sel ? sel.value : null, label: sel ? map[sel.value] : null };
        }
        
        function analyzeAutism() {
            const baseResult = analyzeSection('autism');
            let supportScore = 0;
            // Questions aut8, aut9, aut10 are for support level
            for (let i = 8; i <= 10; i++) {
                const input = document.querySelector(`input[name="autism_aut${i}"]`);
                if (input) supportScore += parseInt(input.value, 10);
            }
            const hasDI = document.querySelector('input[name="aut_di"]:checked') ? true : false;

            let level = 0;
            if (baseResult.percentage > 40) { // Only assign level if base score is significant
                if (supportScore >= 9) level = 3; // high need
                else if (supportScore >= 5) level = 2; // medium need
                else level = 1; // low need
            }
            
            return { ...baseResult, supportLevel: level, hasDI };
        }

        function analyzeBig_five() {
            const data = SECTIONS_DATA.big_five;
            const scores = { O: 0, C: 0, E: 0, A: 0, N: 0 };
            const counts = { O: 0, C: 0, E: 0, A: 0, N: 0 };
            
            data.items.forEach(item => {
                const input = document.querySelector(`input[name="big_five_${item.id}"]`);
                if (input) {
                    let value = parseInt(input.value, 10);
                    if (item.reverse) {
                        value = (5 + 1) - value;
                    }
                    scores[item.trait] += value;
                    counts[item.trait]++;
                }
            });

            const results = {};
            for (const trait in scores) {
                const minScore = counts[trait] * 1;
                const maxScore = counts[trait] * 5;
                results[trait] = Math.round(((scores[trait] - minScore) / (maxScore - minScore)) * 100);
            }
            return results;
        }

        function analyzeLocus_of_control() {
            const data = SECTIONS_DATA.locus_of_control;
            let internalScore = 0, externalScore = 0;
            let internalCount = 0, externalCount = 0;

            data.items.forEach(item => {
                const input = document.querySelector(`input[name="locus_of_control_${item.id}"]`);
                if (input) {
                    const value = parseInt(input.value, 10);
                    if (item.type === 'int') {
                        internalScore += value;
                        internalCount++;
                    } else {
                        externalScore += value;
                        externalCount++;
                    }
                }
            });
            
            const internalAvg = internalScore / internalCount;
            const externalAvg = externalScore / externalCount;

            const totalRange = 4; // 5 - 1
            const internalPct = ((internalAvg - 1) / totalRange) * 100;
            const externalPct = ((externalAvg - 1) / totalRange) * 100;

            let dominant = '√âquilibr√©';
            if (internalPct > externalPct + 10) dominant = 'Interne';
            if (externalPct > internalPct + 10) dominant = 'Externe';

            return { internal: Math.round(internalPct), external: Math.round(externalPct), dominant };
        }

        function enableAllModules() {
            for (const key in MODULES) {
                MODULES[key].enabled = true;
                const cb = document.querySelector(`input[name="module"][value="${key}"]`);
                if (cb) cb.checked = true;
            }
            buildAllSections();
        }

        function fillExample() {
            enableAllModules();
            
            document.getElementById('userName').value = "Jean Exemple";
            
            document.querySelectorAll('#profilerForm input[type="range"]').forEach(r => {
                const name = r.name || '';
                if (name.startsWith('antagonistic_traits')) {
                    const id = name.split('_')[1];
                    const idx = parseInt(id.replace('at',''), 10);
                    if (idx <= 3) r.value = 4; // Mach
                    else if (idx <= 6) r.value = 2; // Narc
                    else if (idx <= 9) r.value = 1; // Psy
                    else r.value = 3; // Soc
                } else {
                    r.value = Math.floor(Math.random() * (parseInt(r.max,10) - parseInt(r.min,10) + 1)) + parseInt(r.min,10);
                }
            });
            
            const mbtiTarget = {mb1:'B', mb4:'B', mb7:'B', mb10:'A'}; // Target INFP-ish
            for (const [id, val] of Object.entries(mbtiTarget)) {
                const input = document.querySelector(`input[name="${id}"][value="${val}"]`);
                if (input) input.checked = true;
            }

            const enneaMain = document.querySelector('input[name="ennea_main"][value="4"]'); if (enneaMain) enneaMain.checked = true;
            [4,6].forEach(v => { const c = document.querySelector(`input[name="ennea_stress"][value="${v}"]`); if (c) c.checked = true; });
            const enneaInstinct = document.querySelector('input[name="instinct"][value="sx"]'); if (enneaInstinct) enneaInstinct.checked = true;
            
            const attachment = document.querySelector('input[name="attachment"][value="anxious_fused"]'); if (attachment) attachment.checked = true;
            const autismDI = document.querySelector('input[name="aut_di"]'); if (autismDI) autismDI.checked = true;

            runAll();
        }
        
        /* ========================== */
        /* == REPORT & PDF GENERATION == */
        /* ========================== */

        let myChart = null; // To hold the chart instance

        function generateReport(allResults) {
            const reportEl = document.getElementById('report');
            reportEl.innerHTML = ''; // Clear

            if (myChart) { myChart.destroy(); myChart = null; }

            const createSection = (icon, title, content) => {
            const section = el('div', { className: 'report-section' });
            section.innerHTML = `<div class="report-title">${icon} ${title}</div>${content}`;
            return section;
            };

            const createBar = (label, rawValue, colorVar) => {
            const value = Math.max(0, Math.min(100, Number(rawValue) || 0));
            return `
                <div>${label} (${value}%)</div>
                <div class="report-bar">
                <i style="width: ${value}%; background-color: var(${colorVar});"></i>
                </div>
            `;
            };

            // Personality Profile
            if (allResults.mbti) {
            const mbtiType = allResults.mbti.type || 'N/A';
            const confidence = allResults.mbti.globalConf != null ? allResults.mbti.globalConf : 'N/A';
            const desc = (DESCRIPTIONS.mbti && DESCRIPTIONS.mbti[mbtiType]) ? DESCRIPTIONS.mbti[mbtiType] : 'Description non disponible.';
            const content = `<p><strong>Type: ${mbtiType}</strong> (Confiance: ${confidence}%)</p>
                     <p class="report-description">${desc}</p>`;
            reportEl.appendChild(createSection('üß†', 'Profil MBTI', content));
            }

            if (allResults.enneagram && allResults.enneagram.type) {
            const wing = allResults.enneagram.wing ? `w${allResults.enneagram.wing}` : '';
            const inst = allResults.enneagram.instinct || 'N/A';
            const desc = (DESCRIPTIONS.enneagram && DESCRIPTIONS.enneagram[allResults.enneagram.type]) ? DESCRIPTIONS.enneagram[allResults.enneagram.type] : 'Description non disponible.';
            const content = `<p><strong>Type ${allResults.enneagram.type}${wing}</strong> - Instinct: ${inst}</p>
                     <p class="report-description">${desc}</p>`;
            reportEl.appendChild(createSection('üåÄ', 'Profil Enn√©agramme', content));
            }

            if (allResults.attachment && allResults.attachment.raw) {
            const content = `<p><strong>${allResults.attachment.label || allResults.attachment.raw}</strong></p>
                     <p class="report-description">${DESCRIPTIONS.attachment?.[allResults.attachment.raw] || ''}</p>`;
            reportEl.appendChild(createSection('‚ù§Ô∏è', 'Style d\'Attachement', content));
            }

            if (allResults.otroverti) {
            let content = createBar('Score Otroverti', allResults.otroverti.percentage, '--accent');
            content += `<p class="report-description">${DESCRIPTIONS.otroverti || ''}</p>`;
            reportEl.appendChild(createSection('üîÑ', 'Profil Otroverti', content));
            }

            // Antagonistic Traits Radar Chart
            if (allResults.antagonistic_traits) {
            const canvasContainer = el('div', { className: 'report-section' });
            canvasContainer.innerHTML = `<div class="report-title">üìà T√©trade Sombre</div><div id="chartContainer"><canvas id="antagonisticChart"></canvas></div>`;

            // build a short descriptive block using safe lookups
            const at = allResults.antagonistic_traits;
            const parts = [];
            if (at.mach != null) parts.push(`<strong>Machiav√©lisme (${at.mach}%):</strong> ${DESCRIPTIONS.antagonistic_traits?.mach || ''}`);
            if (at.narc != null) parts.push(`<strong>Narcissisme (${at.narc}%):</strong> ${DESCRIPTIONS.antagonistic_traits?.narc || ''}`);
            if (at.psy != null) parts.push(`<strong>Psychopathie (${at.psy}%):</strong> ${DESCRIPTIONS.antagonistic_traits?.psy || ''}`);
            if (at.soc != null) parts.push(`<strong>Sociopathie (${at.soc}%):</strong> ${DESCRIPTIONS.antagonistic_traits?.soc || ''}`);

            let content = `<p class="report-description">${parts.join('<br>')}</p>`;
            if (allResults.narcissistic && allResults.narcissistic.percentage > 35) {
                content += `<hr style="border-color: var(--border); margin: 1rem 0;">
                    <p><strong>Indice de Personnalit√© Narcissique : ${allResults.narcissistic.percentage}%</strong></p>
                    <p class="report-description">Ce score est bas√© sur les crit√®res du trouble de la personnalit√© narcissique. Il est important de noter que des traits narcissiques (mesur√©s ci-dessus) ne constituent pas un trouble. Un score √©lev√© ici peut indiquer des sch√©mas de comportement plus rigides et envahissants.</p>`;
            }
            canvasContainer.innerHTML += content;
            reportEl.appendChild(canvasContainer);

            const ctx = document.getElementById('antagonisticChart').getContext('2d');
            const isLightTheme = document.body.classList.contains('light-theme');
            const gridColor = isLightTheme ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
            const textColor = isLightTheme ? '#24292f' : '#c9d1d9';

            myChart = new Chart(ctx, {
                type: 'radar',
                data: {
                labels: ['Machiav√©lisme', 'Narcissisme', 'Psychopathie', 'Sociopathie'],
                datasets: [{
                    label: 'Pourcentage',
                    data: [
                    at.mach || 0,
                    at.narc || 0,
                    at.psy || 0,
                    at.soc || 0
                    ],
                    backgroundColor: 'rgba(248, 81, 73, 0.2)',
                    borderColor: 'rgba(248, 81, 73, 1)',
                    borderWidth: 2
                }]
                },
                options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                    beginAtZero: true,
                    max: 100,
                    grid: { color: gridColor },
                    pointLabels: { color: textColor, font: { size: 12 } },
                    ticks: {
                        backdropColor: 'transparent',
                        color: textColor
                    }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
                }
            });
            }

            // Behavioral Disorders
            // Exclude modules that are shown elsewhere to avoid duplicates
            const excludedFromDisorders = new Set(['otroverti', 'narcissistic', 'big_five', 'locus_of_control', 'grit', 'thinking_styles', 'alexithymia', 'antagonistic_traits']);
            const disorderKeys = Object.keys(allResults).filter(k =>
            allResults[k] &&
            allResults[k].hasOwnProperty('percentage') &&
            !excludedFromDisorders.has(k)
            );

            if (disorderKeys.length > 0) {
            const disorderTitle = el('div', { className: 'section-title', innerText: 'Indices Comportementaux', style: 'margin-top: 1rem; color: var(--text-primary);' });
            reportEl.appendChild(disorderTitle);
            }

            disorderKeys
            .sort((a, b) => (allResults[b].percentage || 0) - (allResults[a].percentage || 0))
            .forEach(key => {
                const result = allResults[key];
                const pct = result.percentage != null ? result.percentage : (result.score != null ? Math.round((result.score / result.maxScore) * 100) : 0);
                if (pct > 35) {
                const title = result.title || SECTIONS_DATA[key]?.title || key;
                let content = createBar('Indice', pct, '--warn');

                // safe description & prevalence fallbacks
                const desc = result.description || DESCRIPTIONS[key] || SECTIONS_DATA[key]?.description || '';
                const prevalence = result.prevalence || SECTIONS_DATA[key]?.prevalence || '';

                if (key === 'autism' && result.supportLevel > 0) {
                    content += `<p><strong>Niveau de soutien indicatif : ${result.supportLevel}</strong> - ${result.hasDI ? 'Avec DI associ√©e.' : 'Sans DI rapport√©e.'}</p>`;
                    const descKey = `level${result.supportLevel}`;
                    let levelDesc = DESCRIPTIONS.autism[descKey] || '';
                    if (result.hasDI && DESCRIPTIONS.autism.with_di) levelDesc += '\n' + DESCRIPTIONS.autism.with_di;
                    content += `<p class="report-description">${levelDesc.replace(/- /g, '\n- ')}</p>`;
                } else {
                    const prevalenceHtml = prevalence ? `<br><strong>Pr√©valence:</strong> ${prevalence}` : '';
                    content += `<p class="report-description">${desc}${prevalenceHtml}</p>`;
                }

                reportEl.appendChild(createSection('‚ö†Ô∏è', title, content));
                }
            });

            // Autres modules
            const otherKeys = ['big_five', 'locus_of_control', 'grit', 'thinking_styles', 'alexithymia'];
            if (otherKeys.some(k => allResults[k])) {
            const otherTitle = el('div', { className: 'section-title', innerText: 'Autres √âvaluations', style: 'margin-top: 1rem; color: var(--text-primary);' });
            reportEl.appendChild(otherTitle);
            }

            if (allResults.big_five) {
            const bf = allResults.big_five;
            let content = createBar('Ouverture', bf.O, '--accent');
            content += createBar('Conscienciosit√©', bf.C, '--good');
            content += createBar('Extraversion', bf.E, '--warn');
            content += createBar('Agr√©abilit√©', bf.A, '--good');
            content += createBar('N√©vrosisme', bf.N, '--bad');
            reportEl.appendChild(createSection('üìä', 'Big Five (OCEAN)', content));
            }

            if (allResults.locus_of_control) {
            const lc = allResults.locus_of_control;
            const dominantDescKey = lc.dominant === 'Interne' ? 'internal' : lc.dominant === 'Externe' ? 'external' : null;
            let content = `<p><strong>Tendance dominante : ${lc.dominant}</strong></p>`;
            content += createBar('Locus Interne', lc.internal, '--good');
            content += createBar('Locus Externe', lc.external, '--warn');
            content += `<p class="report-description">${dominantDescKey ? (DESCRIPTIONS.locus_of_control[dominantDescKey] || '') : ''}</p>`;
            reportEl.appendChild(createSection('üéØ', 'Locus de Contr√¥le', content));
            }

            if (allResults.grit) {
            const pct = allResults.grit.percentage != null ? allResults.grit.percentage : (allResults.grit.score != null ? Math.round((allResults.grit.score / allResults.grit.maxScore) * 100) : 0);
            let content = createBar('Score de Grit', pct, '--accent');
            content += `<p class="report-description">${DESCRIPTIONS.grit || ''}</p>`;
            reportEl.appendChild(createSection('üí™', 'Grit (Pers√©v√©rance)', content));
            }

            if (allResults.alexithymia) {
            const pct = allResults.alexithymia.percentage != null ? allResults.alexithymia.percentage : 0;
            let content = createBar('Indice d\'Alexithymie', pct, '--warn');
            content += `<p class="report-description">${DESCRIPTIONS.alexithymia || ''}</p>`;
            reportEl.appendChild(createSection('üò∂', 'Alexithymie', content));
            }

            if (allResults.thinking_styles) {
            let content = `<p class="report-description">${DESCRIPTIONS.thinking_styles || ''}</p>`;
            // protect access to items and DOM inputs
            const items = allResults.thinking_styles.items || SECTIONS_DATA.thinking_styles?.items || [];
            const topStyles = items
                .map((item) => {
                const input = document.querySelector(`input[name="thinking_styles_${item.id}"]`);
                const score = input ? (parseInt(input.value, 10) || 0) : 0;
                return { ...item, score };
                })
                .filter(item => item.score > 2)
                .sort((a, b) => b.score - a.score);

            if (topStyles.length > 0) {
                content += '<strong>Distorsions les plus fr√©quentes :</strong><ul>';
                topStyles.forEach(style => {
                content += `<li>${(style.text || '').split(':')[0]}</li>`;
                });
                content += '</ul>';
            } else {
                content += '<p>Aucune distorsion cognitive majeure d√©tect√©e.</p>';
            }
            reportEl.appendChild(createSection('ü§î', 'Styles de Pens√©e', content));
            }
        }
        
        function generateSummary(allResults) {
            let summary = "Ce rapport pr√©sente une synth√®se des auto-√©valuations. ";
            const userName = document.getElementById('userName').value || 'La personne';

            if (allResults.mbti) {
                summary += `${userName} pr√©sente un profil de personnalit√© de type ${allResults.mbti.type} (${DESCRIPTIONS.mbti[allResults.mbti.type].split(':')[0]}). `;
            }
            if (allResults.enneagram && allResults.enneagram.type) {
                summary += `Le profil Enn√©agramme dominant est le Type ${allResults.enneagram.type} (${DESCRIPTIONS.enneagram[allResults.enneagram.type].split(':')[0]}). `;
            }
            if (allResults.attachment && allResults.attachment.label) {
                summary += `Le style d'attachement principal semble √™tre de type ${allResults.attachment.label}. `;
            }

            const significantScores = Object.entries(allResults)
                .filter(([key, value]) => value && value.hasOwnProperty('percentage') && value.percentage > 50 && !['otroverti'].includes(key))
                .sort(([, a], [, b]) => b.percentage - a.percentage);

            if (significantScores.length > 0) {
                summary += "\n\nLes indices comportementaux les plus notables incluent :";
                significantScores.slice(0, 3).forEach(([key, value]) => {
                    const displayTitle = value.title || key;
                    const descBase = (value.description || value.title || '').split('.')[0].trim();
                    if (descBase) {
                        summary += `\n- Un score √©lev√© pour "${displayTitle}" (${value.percentage}%), sugg√©rant ${descBase.toLowerCase()}.`;
                    } else {
                        summary += `\n- Un score √©lev√© pour "${displayTitle}" (${value.percentage}%).`;
                    }
                });
            }
            
            if (allResults.antagonistic_traits) {
                const traits = allResults.antagonistic_traits;
                const highestTrait = Object.keys(traits).reduce((a, b) => traits[a] > traits[b] ? a : b);
                if (traits[highestTrait] > 50) {
                    summary += `\nParmi les traits de la t√©trade sombre, le ${highestTrait} est le plus prononc√©.`;
                }
            }
            
            summary += "\n\nCe r√©sum√© est une interpr√©tation automatis√©e et ne doit pas remplacer une √©valuation clinique compl√®te."
            return summary;
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const userName = document.getElementById('userName').value || 'Anonyme';
            const allResults = analyzeAllEnabledSections();
            if (Object.keys(allResults).length === 0) { alert("Veuillez d'abord analyser un profil."); return; }

            let y = 45;
            const addSection = (title, body) => {
            if (y > 250) { doc.addPage(); y = 20; }
            doc.setFontSize(14); doc.setTextColor(44, 62, 80); doc.text(title, 14, y); y += 8;
            doc.setFontSize(10); doc.setTextColor(80, 80, 80);

            const safeBody = (body === undefined || body === null) ? '' : String(body);
            const lines = safeBody.split('\n');
            lines.forEach(line => {
            const isListItem = line.trim().startsWith('-') || line.trim().startsWith('‚Ä¢');
            const textToSplit = isListItem ? line.trim().substring(1).trim() : line;
            const splitText = doc.splitTextToSize(textToSplit, 180);

            if (isListItem) {
            doc.text('‚Ä¢', 16, y);
            doc.text(splitText, 20, y);
            } else {
            doc.text(splitText, 14, y);
            }
            y += (Array.isArray(splitText) ? splitText.length : 1) * 4 + (isListItem ? 2 : 4);
            if (y > 270) { doc.addPage(); y = 20; }
            });
            y += 6;
            };

            // --- En-t√™te ---
            doc.setFontSize(20); doc.setTextColor(44, 62, 80);
            doc.text(`Rapport de Profil pour ${userName}`, 105, 20, { align: 'center' });
            doc.setFontSize(10); doc.setTextColor(150, 150, 150);
            doc.text(`G√©n√©r√© le: ${new Date().toLocaleString('fr-FR')}`, 105, 28, { align: 'center' });
            doc.setLineWidth(0.5); doc.setDrawColor(220, 220, 220); doc.line(14, 35, 196, 35);

            // --- R√©sum√© ---
            addSection("R√©sum√© du Profil", generateSummary(allResults));

            // --- Sections Personnalit√© ---
            if (allResults.mbti) addSection("Profil MBTI", `Type: ${allResults.mbti.type} (Confiance: ${allResults.mbti.globalConf}%)\n${DESCRIPTIONS.mbti[allResults.mbti.type] || ''}`);
            if (allResults.enneagram && allResults.enneagram.type) {
            const wing = allResults.enneagram.wing ? `w${allResults.enneagram.wing}` : '';
            addSection("Profil Enn√©agramme", `Type ${allResults.enneagram.type}${wing} - Instinct: ${allResults.enneagram.instinct || 'N/A'}\n${DESCRIPTIONS.enneagram[allResults.enneagram.type] || ''}`);
            }
            if (allResults.attachment && allResults.attachment.raw) addSection("Style d'Attachement", `${allResults.attachment.label}\n${DESCRIPTIONS.attachment[allResults.attachment.raw] || ''}`);

            // Ajouter la section Otroverti (Ambiverti)
            if (allResults.otroverti) {
            addSection("Profil Otroverti (Ambiverti)", `Score: ${allResults.otroverti.percentage != null ? allResults.otroverti.percentage + '%' : 'N/A'}\n${DESCRIPTIONS.otroverti || ''}`);
            }

            if (allResults.antagonistic_traits) {
                const at = allResults.antagonistic_traits;
                const machPct = (at.mach != null) ? `${at.mach}%` : 'N/A';
                const narcPct = (at.narc != null) ? `${at.narc}%` : 'N/A';
                const psyPct  = (at.psy  != null) ? `${at.psy}%`  : 'N/A';
                const socPct  = (at.soc  != null) ? `${at.soc}%`  : 'N/A';

                // Build descriptive block using DESCRIPTIONS if available
                const descr = [];
                if (DESCRIPTIONS.antagonistic_traits) {
                    if (DESCRIPTIONS.antagonistic_traits.mach) descr.push(`Machiav√©lisme : ${DESCRIPTIONS.antagonistic_traits.mach}`);
                    if (DESCRIPTIONS.antagonistic_traits.narc) descr.push(`Narcissisme : ${DESCRIPTIONS.antagonistic_traits.narc}`);
                    if (DESCRIPTIONS.antagonistic_traits.psy)  descr.push(`Psychopathie : ${DESCRIPTIONS.antagonistic_traits.psy}`);
                    if (DESCRIPTIONS.antagonistic_traits.soc)  descr.push(`Sociopathie : ${DESCRIPTIONS.antagonistic_traits.soc}`);
                }

                const body = `Machiav√©lisme: ${machPct}\nNarcissisme: ${narcPct}\nPsychopathie: ${psyPct}\nSociopathie: ${socPct}\n\n${descr.join('\n\n')}`;

                addSection('T√©trade Sombre (Dark Tetrad)', body);

                // Also add a small table summarizing the four trait percentages for easier reading in the PDF
                if (y > 240) { doc.addPage(); y = 20; }
                doc.autoTable({
                    startY: y,
                    head: [['Trait', 'Pourcentage']],
                    body: [
                        ['Machiav√©lisme', machPct],
                        ['Narcissisme', narcPct],
                        ['Psychopathie', psyPct],
                        ['Sociopathie', socPct]
                    ],
                    theme: 'grid',
                    headStyles: { fillColor: [44, 62, 80] }
                });
                y = doc.autoTable.previous.finalY + 10;
            }

            // --- Tableau des r√©sultats quantitatifs ---
            const tableBody = [];
            const disorderKeys = Object.keys(allResults).filter(k => 
            allResults[k] && 
            allResults[k].hasOwnProperty('percentage')
            );

            // Construire liste ordonn√©e et d√©dupliquer
            const ordered = ['otroverti', 'grit', 'alexithymia', ...disorderKeys];
            const uniqueKeys = Array.from(new Set(ordered));

            uniqueKeys.forEach(key => {
            const result = allResults[key];
            if (result && result.percentage != null && result.percentage > 35) {
            const title = result.title || SECTIONS_DATA[key]?.title || key;
            tableBody.push([title, `${result.percentage}%`]);
            }
            });

            // Inclure la r√©partition Big Five si pr√©sente
            if (allResults.big_five) {
            const bf = allResults.big_five;
            tableBody.push(['Big Five ‚Äî Ouverture', `${bf.O}%`]);
            tableBody.push(['Big Five ‚Äî Conscienciosit√©', `${bf.C}%`]);
            tableBody.push(['Big Five ‚Äî Extraversion', `${bf.E}%`]);
            tableBody.push(['Big Five ‚Äî Agr√©abilit√©', `${bf.A}%`]);
            tableBody.push(['Big Five ‚Äî N√©vrosisme', `${bf.N}%`]);
            }

            // Inclure d√©tails Locus de Contr√¥le
            if (allResults.locus_of_control) {
            const lc = allResults.locus_of_control;
            tableBody.push(['Locus de Contr√¥le ‚Äî Interne', `${lc.internal}%`]);
            tableBody.push(['Locus de Contr√¥le ‚Äî Externe', `${lc.external}%`]);
            tableBody.push(['Locus de Contr√¥le ‚Äî Tendance dominante', `${lc.dominant}`]);
            }

            if (allResults.antagonistic_traits) {
            const at = allResults.antagonistic_traits;
            tableBody.push(['Machiav√©lisme', `${at.mach}%`]);
            tableBody.push(['Narcissisme (trait)', `${at.narc}%`]);
            tableBody.push(['Psychopathie (trait)', `${at.psy}%`]);
            tableBody.push(['Sociopathie (trait)', `${at.soc}%`]);
            }

            if (tableBody.length > 0) {
            if (y > 240) { doc.addPage(); y = 20; }
            doc.autoTable({ 
            startY: y, 
            head: [['Indicateur', 'R√©sultat']], 
            body: tableBody, 
            theme: 'grid', 
            headStyles: { fillColor: [44, 62, 80] } 
            });
            y = doc.autoTable.previous.finalY + 10;
            }

            // --- Sections comportementales d√©taill√©es ---
            disorderKeys.forEach(key => {
            const result = allResults[key];
            if (!result || (result.percentage == null) || result.percentage <= 35) return;

            // R√©cup√©rer donn√©es de section et description
            const sectionData = SECTIONS_DATA[key];
            let desc = '';
            
            // Construire description selon le type de section
            if (key === 'adhd') {
            desc = "Sch√©ma comportemental caract√©ris√© par des difficult√©s √† maintenir l'attention, de l'hyperactivit√© et de l'impulsivit√© qui interf√®rent avec le fonctionnement ou le d√©veloppement.\n\nPr√©valence : environ 2,5‚Äì7% chez l'adulte et 5‚Äì12% chez l'enfant.";
            } else if (key === 'grit') {
            desc = "Pers√©v√©rance et passion pour des objectifs √† long terme. Un score √©lev√© indique une capacit√© √† maintenir l'effort et l'int√©r√™t malgr√© les revers et l'adversit√©.";
            } else if (key === 'alexithymia') {
            desc = "Difficult√© √† identifier et √† d√©crire ses √©motions, √† distinguer les √©motions des sensations corporelles et √† exprimer ses sentiments. Souvent associ√©e √† un style de pens√©e concret et orient√© vers l'ext√©rieur.";
            } else {
            desc = result.description || DESCRIPTIONS[key] || sectionData?.description || sectionData?.title || '';
            }

            if (key === 'autism' && result.supportLevel > 0) {
            desc = `Niveau de soutien indicatif : ${result.supportLevel} (${result.hasDI ? 'Avec DI' : 'Sans DI'})\n${DESCRIPTIONS.autism[`level${result.supportLevel}`] || ''}`;
            }

            if (key === 'thinking_styles' && result.percentage > 35) {
            const items = SECTIONS_DATA.thinking_styles?.items || [];
            const scored = items.map(it => {
            const input = document.querySelector(`input[name="thinking_styles_${it.id}"]`);
            return { text: it.text, score: input ? (parseInt(input.value, 10) || 0) : 0 };
            }).filter(i => i.score > 2).sort((a, b) => b.score - a.score);
            
            if (scored.length) {
            desc = "Les distorsions cognitives sont des sch√©mas syst√©matiques de pens√©e qui s'√©loignent de la rationalit√©.\n\nDistorsions les plus fr√©quentes :\n" + 
                   scored.slice(0, 5).map(s => `‚Ä¢ ${s.text.split(':')[0].trim()}`).join('\n');
            }
            }

            const title = result.title || sectionData?.title || key;
            addSection(`${title} (Indice ${result.percentage}%)`, desc);
            });

            // --- Sections suppl√©mentaires pour Big Five et Locus si pr√©sentes ---
            if (allResults.big_five) {
            const bf = allResults.big_five;
            let content = `Ouverture : ${bf.O}%\nConscienciosit√© : ${bf.C}%\nExtraversion : ${bf.E}%\nAgr√©abilit√© : ${bf.A}%\nN√©vrosisme : ${bf.N}%\n\n${DESCRIPTIONS.big_five ? (typeof DESCRIPTIONS.big_five === 'object' ? Object.entries(DESCRIPTIONS.big_five).map(([k,v])=>`${k}: ${v}`).join('\n') : DESCRIPTIONS.big_five) : ''}`;
            addSection('Big Five (OCEAN)', content);
            }

            if (allResults.locus_of_control) {
            const lc = allResults.locus_of_control;
            let content = `Interne : ${lc.internal}%\nExterne : ${lc.external}%\nTendance dominante : ${lc.dominant}\n\n${DESCRIPTIONS.locus_of_control ? (DESCRIPTIONS.locus_of_control.internal + '\n' + DESCRIPTIONS.locus_of_control.external) : ''}`;
            addSection('Locus de Contr√¥le', content);
            }

            // S'assurer que les d√©tails Otroverti sont pr√©sents si non inclus pr√©c√©demment (sauvegarde)
            if (allResults.otroverti && (!disorderKeys.includes('otroverti'))) {
            addSection("Profil Otroverti (Ambiverti)", `Score: ${allResults.otroverti.percentage != null ? allResults.otroverti.percentage + '%' : 'N/A'}\n${DESCRIPTIONS.otroverti || ''}`);
            }

            // --- Footer ---
            const disclaimer = "AVERTISSEMENT : Ce rapport est g√©n√©r√© √† des fins √©ducatives et ne constitue pas un diagnostic. Les r√©sultats sont des indicateurs bas√©s sur un auto-questionnaire et ne remplacent pas l'avis d'un professionnel de sant√© mentale.";
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8); doc.setTextColor(150, 150, 150);
            const splitDisclaimer = doc.splitTextToSize(disclaimer, 180);
            doc.text(splitDisclaimer, 14, 285, { baseline: 'bottom'});
            doc.text(`Cr√©√© par DFWS | Page ${i}/${pageCount}`, 196, 290, { align: 'right'});
            }
            
            doc.save(`Rapport_Profiler_${userName.replace(' ','_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        /* ======================== */
        /* == MAIN & UTILITIES   == */
        /* ======================== */

        function runAll() {
            const allResults = analyzeAllEnabledSections();
            if (Object.keys(allResults).length === 0) { alert('Veuillez s√©lectionner au moins un module √† analyser.'); return; }
            generateReport(allResults);
            const out = { timestamp: (new Date()).toISOString(), name: document.getElementById('userName').value, results: allResults };
            document.getElementById('jsonOut').innerText = JSON.stringify(out, null, 2);
        }

        function clearForm() {
            document.getElementById('profilerForm').reset();
            document.getElementById('report').innerHTML = 'Veuillez s√©lectionner les modules, remplir les questionnaires et cliquer sur "Analyser".';
            document.getElementById('jsonOut').innerText = '‚Äî';
            if (myChart) { myChart.destroy(); myChart = null; }
        }

        function exportJson() {
            const json = document.getElementById('jsonOut').innerText;
            if (json === '‚Äî') { alert("G√©n√©rez une analyse avant d'exporter."); return; }
            const blob = new Blob([json], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `profil-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        document.getElementById('importFile').addEventListener('change', (e) => {
            const f = e.target.files[0]; if (!f) return;
            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const data = JSON.parse(event.target.result);
                    if (!data || !data.results) throw new Error('Format invalide');
                    document.getElementById('jsonOut').innerText = JSON.stringify(data, null, 2);
                    if (data.name) document.getElementById('userName').value = data.name;
                    generateReport(data.results);
                } catch (err) { alert('Erreur: Fichier JSON invalide.'); console.error(err); }
            };
            reader.readAsText(f);
        });

        function initLangSelector() {
            const sel = document.getElementById('langSelect');
            if (!sel) return;
            const fn = (window.location.pathname.split('/').pop() || '').toLowerCase();
            if (fn.includes('en-us')) sel.value = 'en-us.html';
            else if (fn.includes('nl-be')) sel.value = 'nl-be.html';
            else sel.value = 'index.html';
            sel.addEventListener('change', () => { window.location.href = sel.value; });
        }

        function initThemeToggle() {
            const toggle = document.getElementById('themeToggle');
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-theme');
            }
            toggle.addEventListener('click', () => {
                document.body.classList.toggle('light-theme');
                localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
                // Re-run analysis to redraw chart with correct colors if it exists
                if (document.getElementById('jsonOut').innerText !== '‚Äî') {
                    runAll();
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => { 
            // Assign analysis functions to window object to be callable by name
            window.analyzeMbti = analyzeMbti;
            window.analyzeEnneagram = analyzeEnneagram;
            window.analyzeAntagonistic_traits = analyzeAntagonistic_traits;
            window.analyzeAttachment = analyzeAttachment;
            window.analyzeAutism = analyzeAutism;
            window.analyzeBig_five = analyzeBig_five;
            window.analyzeLocus_of_control = analyzeLocus_of_control;
            window.analyzeGrit = () => analyzeSection('grit');
            window.analyzeOtroverti = () => analyzeSection('otroverti');
            window.analyzeAdhd = () => analyzeSection('adhd');
            window.analyzeTop = () => analyzeSection('top');
            window.analyzeConduct = () => analyzeSection('conduct');
            window.analyzeIntermittent = () => analyzeSection('intermittent');
            window.analyzeAntisocial = () => analyzeSection('antisocial');
            window.analyzeBorderline = () => analyzeSection('borderline');
            window.analyzeNarcissistic = () => analyzeSection('narcissistic');
            window.analyzeOcpd = () => analyzeSection('ocpd');
            window.analyzeChild_top = () => analyzeSection('child_top');
            window.analyzeChild_conduct = () => analyzeSection('child_conduct');
            window.analyzeChild_anxiety = () => analyzeSection('child_anxiety');
            window.analyzeChild_eating = () => analyzeSection('child_eating');
            window.analyzeSocial_phobia = () => analyzeSection('social_phobia');
            window.analyzeOcd = () => analyzeSection('ocd');
            window.analyzeEating_disorder = () => analyzeSection('eating_disorder');
            window.analyzeAddiction = () => analyzeSection('addiction');
            window.analyzeThinking_styles = () => analyzeSection('thinking_styles');
            window.analyzeAlexithymia = () => analyzeSection('alexithymia');

            build(); 
            initLangSelector(); 
            initThemeToggle(); 
        });
    </script>
</body>
</html>